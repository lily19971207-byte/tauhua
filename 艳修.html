<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆæ¬¢å®—ä¿®ç‚¼æ¨¡æ‹Ÿå™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#a9b688',
            secondary: '#9ED2BE',
            tertiary: '#9EC3FF',
            quaternary: '#FFD591',
            background: '#FFF5F7',
            text: '#5A4B60',
          },
          fontFamily: {
            sans: ['Microsoft YaHei', 'SimHei', 'Arial', 'sans-serif'],
          },
          animation: {
            'bounce-slow': 'bounce 3s infinite',
            'float': 'float 6s ease-in-out infinite',
            'fade-in': 'fadeIn 0.3s ease-in',
            'slide-up': 'slideUp 0.3s ease-out',
            'float-slow': 'floatSlow 8s ease-in-out infinite',
            'pulse-slow': 'pulseSlow 4s ease-in-out infinite',
            'spin-slow': 'spinSlow 20s linear infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            floatSlow: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-20px)' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            pulseSlow: {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '0.7' },
            },
            spinSlow: {
              '0%': { transform: 'rotate(0deg)' },
              '100%': { transform: 'rotate(360deg)' },
            }
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
      }
      .card-shadow {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .btn-shadow {
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      }
      .glow {
        box-shadow: 0 0 10px rgba(169, 182, 136, 0.3);
      }
      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .glass-dark {
        background: rgba(90, 75, 96, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .text-gradient {
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        background-image: linear-gradient(135deg, #a9b688, #9ED2BE);
      }
      .bg-gradient-primary {
        background-image: linear-gradient(135deg, #a9b688, #9ED2BE);
      }
      .bg-gradient-secondary {
        background-image: linear-gradient(135deg, #9EC3FF, #FFD591);
      }
      .bg-gradient-accent {
        background-image: linear-gradient(135deg, #FFD591, #FFB6C1);
      }
      .border-gradient {
        border-image: linear-gradient(135deg, #a9b688, #9ED2BE) 1;
      }
      .animate-float {
        animation: float 6s ease-in-out infinite;
      }
      .animate-float-slow {
        animation: floatSlow 8s ease-in-out infinite;
      }
      .animate-pulse-slow {
        animation: pulseSlow 4s ease-in-out infinite;
      }
      .animate-spin-slow {
        animation: spinSlow 20s linear infinite;
      }
    }
    
    body {
      background: linear-gradient(135deg, #FFF5F7 0%, #f5f0f8 100%);
      color: theme('colors.text');
      font-family: theme('fontFamily.sans');
      overflow-x: hidden;
    }
    
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      position: relative;
      background-color: #fff;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
    }
    
    .stat-bar {
      height: 8px;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .btn {
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }
    
    .event-card {
      animation: slideUp 0.3s ease-out;
    }
    
    .notification {
      animation: slideUp 0.3s ease-out;
    }
    
    .page-content {
      display: none;
    }
    
    .page-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    
    .bg-pattern {
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23a9b688' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .bg-overlay {
      background: linear-gradient(to bottom, rgba(255, 245, 247, 0.8), rgba(255, 245, 247, 0.95));
    }
    
    .character-avatar {
      position: relative;
      overflow: hidden;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      border: 3px solid #fff;
      box-shadow: 0 0 15px rgba(169, 182, 136, 0.3);
    }
    
    .character-avatar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 50%;
      box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.5);
      pointer-events: none;
    }
    
    .npc-avatar {
      position: relative;
      overflow: hidden;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      border: 2px solid #fff;
      box-shadow: 0 0 10px rgba(169, 182, 136, 0.2);
    }
    
    .bg-scene {
      background-image: url('https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/c234ed4ffd8b45b58077b26952357c6f~tplv-a9rns2rl98-image.image?rcl=20251107154009649CA6622D232BA389A9&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1765093230&x-signature=SQuaHmV4GOHG85UY0b1IKKkQeH0%3D');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .scene-overlay {
      background: linear-gradient(to bottom, rgba(255, 245, 247, 0.7), rgba(255, 245, 247, 0.9));
    }
    
    .particle {
      position: absolute;
      background-color: rgba(255, 182, 193, 0.5);
      border-radius: 50%;
      pointer-events: none;
    }
    
    .skill-card {
      position: relative;
      overflow: hidden;
    }
    
    .skill-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s infinite;
      opacity: 0;
    }
    
    @keyframes shine {
      0% {
        transform: translateX(-100%) rotate(45deg);
        opacity: 0;
      }
      50% {
        opacity: 0.3;
      }
      100% {
        transform: translateX(100%) rotate(45deg);
        opacity: 0;
      }
    }
    
    .skill-card:hover::before {
      animation: shine 1.5s infinite;
    }
    
    .item-card {
      transition: all 0.3s ease;
    }
    
    .item-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .nav-btn {
      transition: all 0.3s ease;
    }
    
    .nav-btn.active {
      position: relative;
    }
    
    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 3px;
      background-color: theme('colors.primary');
      border-radius: 3px;
    }
    
    .modal-content {
      max-height: 70vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: theme('colors.primary') transparent;
    }
    
    .modal-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .modal-content::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .modal-content::-webkit-scrollbar-thumb {
      background-color: theme('colors.primary');
      border-radius: 20px;
    }
    
    /* åŠå¸‚ç‰¹æ®Šå¸ƒå±€ï¼šå›ºå®šå¤´éƒ¨å’Œåº•éƒ¨ï¼Œä¸­é—´æ»šåŠ¨ */
    .modal-content .market-scroll-area::-webkit-scrollbar {
      width: 6px;
    }
    
    .modal-content .market-scroll-area::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .modal-content .market-scroll-area::-webkit-scrollbar-thumb {
      background-color: theme('colors.primary');
      border-radius: 20px;
    }
    
    .progress-ring {
      transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
      transition: stroke-dashoffset 0.5s ease;
      transform-origin: 50% 50%;
    }
    
    .floating-element {
      animation: float 6s ease-in-out infinite;
    }
    
    .floating-element:nth-child(2) {
      animation-delay: 1s;
    }
    
    .floating-element:nth-child(3) {
      animation-delay: 2s;
    }
    
    .floating-element:nth-child(4) {
      animation-delay: 3s;
    }
    
    .floating-element:nth-child(5) {
      animation-delay: 4s;
    }
  </style>
</head>
<body>
  <div class="app-container bg-pattern">
    <!-- èƒŒæ™¯å±‚ -->
    <div class="fixed inset-0 bg-scene opacity-10 z-0"></div>
    
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <header class="bg-gradient-primary text-white p-4 text-center shadow-lg relative z-10">
      <h1 class="text-2xl font-bold text-shadow">ğŸŒ¸ åˆæ¬¢å®—ä¿®ç‚¼æ¨¡æ‹Ÿå™¨</h1>
      <div class="mt-2 text-sm opacity-90" id="time-display">ç¬¬1å¤©Â·æ¸…æ™¨Â·è¾°æ—¶</div>
    </header>

    <!-- ä¸»é¡µé¢ -->
    <main id="main-page" class="page-content active p-4 pb-24 relative z-10">
      <!-- è§’è‰²å±æ€§é¢æ¿ -->
      <div id="stats-panel" class="bg-white rounded-xl p-4 mb-4 card-shadow overflow-hidden relative">
        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-primary rounded-full filter blur-3xl opacity-10 -translate-y-1/2 translate-x-1/2"></div>
        
        <div class="flex items-center mb-4">
          <div class="character-avatar mr-4 animate-float-slow">
            <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/5dd840c7fa864d8085a29f67d2e7098b~tplv-a9rns2rl98-image.image?rcl=20251107154009649CA6622D232BA389A9&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1765093240&x-signature=WBhHVqE%2BtB9wcbdMcbtEUbbYPhs%3D" 
                 alt="è§’è‰²å¤´åƒ" class="w-full h-full object-cover">
          </div>
          <div class="flex-1">
            <h2 class="text-lg font-bold text-primary">ğŸ“Š è§’è‰²å±æ€§</h2>
            <div class="flex justify-between mt-1">
              <span>ã€å§“åã€‘</span>
              <span id="character-name" class="font-bold text-primary">æ¡ƒå¤­</span>
            </div>
            <div class="flex justify-between">
              <span>ã€æ€§åˆ«ã€‘</span>
              <span id="character-gender" class="font-bold">å¥³</span>
            </div>
            <div class="flex justify-between">
              <span>ã€ä½“è´¨ã€‘</span>
              <span id="constitution" class="font-bold text-pink-500">å¤©ç”Ÿåªšéª¨</span>
            </div>
            <div class="flex justify-between" id="pregnancy-status" style="display: none;">
              <span>ã€èº«å­•ğŸ¤°ã€‘</span>
              <span id="pregnancy-info" class="font-bold text-pink-600"></span>
            </div>
          </div>
        </div>
        
        <div class="space-y-3 text-sm">
          <div>
            <div class="flex justify-between mb-1">
              <span>ã€å¯¿å…ƒğŸ‘¤ã€‘</span>
              <span id="lifespan-value">18/100</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div id="lifespan-bar" class="stat-bar bg-gradient-to-r from-red-400 to-red-500" style="width: 18%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-1">
              <span>ã€ä¿®ä¸ºğŸ“Šã€‘</span>
              <span id="cultivation-level">ç‚¼æ°”åˆæœŸ (75/100)</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div id="cultivation-bar" class="stat-bar bg-gradient-to-r from-purple-400 to-purple-600" style="width: 75%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-1">
              <span>ã€é­…åŠ›ğŸŒ¸ã€‘</span>
              <span id="charm-value">70/100</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div id="charm-bar" class="stat-bar bg-gradient-to-r from-pink-400 to-pink-600" style="width: 70%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-1">
              <span>ã€æ ¹éª¨ğŸ¦µã€‘</span>
              <span id="talent-value">15/100</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div id="talent-bar" class="stat-bar bg-gradient-to-r from-blue-400 to-blue-600" style="width: 15%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-1">
              <span>ã€æ‚Ÿæ€§ğŸ§ ã€‘</span>
              <span id="wisdom-value">10/100</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div id="wisdom-bar" class="stat-bar bg-gradient-to-r from-indigo-400 to-indigo-600" style="width: 10%"></div>
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-2 mt-2">
            <div class="bg-pink-50 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">çµåŠ›ğŸ’§</div>
              <div id="spiritual-power" class="font-bold text-pink-600">20/20</div>
            </div>
            <div class="bg-green-50 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">ä½“é­„ğŸ’ª</div>
              <div id="physique" class="font-bold text-green-600">10/10</div>
            </div>
            <div class="bg-red-50 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">ä¸šéšœğŸ­</div>
              <div id="karma" class="font-bold text-red-600">0/100</div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-2">
            <div class="bg-purple-50 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">è‰³åâœ¨</div>
              <div id="reputation" class="font-bold text-purple-600">5/100 (é»˜é»˜æ— é—»)</div>
            </div>
            <div class="bg-yellow-50 rounded-lg p-2 text-center">
              <div class="text-xs text-gray-600">çµçŸ³ğŸ’°</div>
              <div id="spirit-stones" class="font-bold text-yellow-600">500</div>
            </div>
          </div>
          
          <!-- å­å—£åˆ—è¡¨ -->
          <div id="children-section" class="mt-3" style="display: none;">
            <div class="text-xs text-gray-600 mb-1">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å­å—£</div>
            <div id="children-list">
              <!-- å­å—£åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>
      </div>

      <!-- å½“å‰äº‹ä»¶é¢æ¿ -->
      <div id="event-panel" class="bg-white rounded-xl p-4 mb-4 card-shadow event-card overflow-hidden relative">
        <div class="absolute top-0 left-0 w-full h-full bg-gradient-accent opacity-5"></div>
        <div class="relative z-10">
          <h2 class="text-lg font-bold mb-3 text-primary">ğŸ“œ å½“å‰åœºæ™¯</h2>
          <div id="event-content" class="text-sm leading-relaxed mb-4 text-gray-700 bg-white bg-opacity-70 p-3 rounded-lg">
            <p>ä½ ä»é²›ç»¡çº±å¸ä¸­é†’æ¥ï¼Œæ‰«è¿‡èº«ä¾§é…£ç¡çš„å‰‘å®—é¦–å¸­å¼Ÿå­ï¼ˆæ˜¨å¤œåŒä¿®å¯¹è±¡ï¼‰ã€‚çª—å¤–é£æ¥å¸ˆå°Šä¼ è®¯ç¬¦å‘ŠçŸ¥ä½ ä¸‰æ—¥åè“¬è±ä»™å®´å°½æ˜¯ä¸Šä½³ç‚‰é¼ã€‚</p>
          </div>
          <div id="event-choices" class="space-y-2"></div>
        </div>
      </div>

      <!-- è¡ŒåŠ¨é¢æ¿ -->
      <div id="action-panel" class="bg-white rounded-xl p-4 card-shadow overflow-hidden relative">
        <div class="absolute bottom-0 right-0 w-32 h-32 bg-gradient-secondary rounded-full filter blur-3xl opacity-10 translate-y-1/2 translate-x-1/2"></div>
        <div class="relative z-10">
          <h2 class="text-lg font-bold mb-3 text-primary">âš¡ é€‰æ‹©è¡ŒåŠ¨</h2>
          <div class="grid grid-cols-2 gap-3" id="action-buttons">
            <!-- è¡ŒåŠ¨æŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </main>

    <!-- NPCé¡µé¢ -->
    <div id="npc-page" class="page-content p-4 pb-24 relative z-10">
      <div class="bg-white rounded-xl p-4 card-shadow mb-4 overflow-hidden relative">
        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-accent rounded-full filter blur-3xl opacity-10 -translate-y-1/2 translate-x-1/2"></div>
        <div class="relative z-10">
          <h2 class="text-lg font-bold mb-3 text-primary">ğŸ’– å› ç¼˜å½•</h2>
          <div id="npc-list">
            <!-- NPCåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>

    <!-- åŠŸæ³•é¡µé¢ -->
    <div id="skill-page" class="page-content p-4 pb-24 relative z-10">
      <div class="bg-white rounded-xl p-4 card-shadow mb-4 overflow-hidden relative">
        <div class="absolute top-0 left-0 w-32 h-32 bg-gradient-primary rounded-full filter blur-3xl opacity-10 -translate-y-1/2 -translate-x-1/2"></div>
        <div class="relative z-10">
          <h2 class="text-lg font-bold mb-3 text-primary">ğŸ§¾ åŠŸæ³•ç§˜ç±</h2>
          <div id="skill-list" class="space-y-3">
            <!-- åŠŸæ³•åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>

    <!-- ç‰©å“é¡µé¢ -->
    <div id="item-page" class="page-content p-4 pb-24 relative z-10">
      <div class="bg-white rounded-xl p-4 card-shadow mb-4 overflow-hidden relative">
        <div class="absolute bottom-0 left-0 w-32 h-32 bg-gradient-secondary rounded-full filter blur-3xl opacity-10 translate-y-1/2 -translate-x-1/2"></div>
        <div class="relative z-10">
          <h2 class="text-lg font-bold mb-3 text-primary">ğŸ§° ç‰©å“æ </h2>
          <div id="item-list" class="space-y-3">
            <!-- ç‰©å“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>

    <!-- è®¾ç½®é¡µé¢ -->
    <div id="settings-page" class="page-content p-4 pb-24 relative z-10">
      <div class="bg-white rounded-xl p-4 card-shadow mb-4 overflow-hidden relative">
        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-primary rounded-full filter blur-3xl opacity-10 -translate-y-1/2 translate-x-1/2"></div>
        <div class="relative z-10">
          <h2 class="text-lg font-bold mb-4 text-primary">âš™ï¸ è®¾ç½®</h2>
          
          <!-- æ¸¸æˆç®¡ç† -->
          <div class="bg-red-50 rounded-lg p-4 mb-4 border border-red-200">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center">
                <svg class="w-6 h-6 text-red-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <div>
                  <h3 class="font-medium text-red-600">æ¸¸æˆç®¡ç†</h3>
                  <p class="text-xs text-gray-600">é‡æ–°å¼€å§‹æ¸¸æˆ</p>
                </div>
              </div>
              <button id="restart-game-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                é‡æ–°å¼€å§‹
              </button>
            </div>
            <p class="text-xs text-red-400 mt-2">âš ï¸ æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ¸¸æˆæ•°æ®ï¼Œä¸å¯æ¢å¤</p>
          </div>
          
          <!-- æ•°æ®ç®¡ç† -->
          <div class="bg-white rounded-lg p-4 border-2 border-primary card-shadow">
            <div class="flex items-center mb-3">
              <div class="w-10 h-10 bg-primary bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                <svg class="w-6 h-6 text-primary" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <h3 class="font-medium text-primary">æ•°æ®ç®¡ç†</h3>
                <p class="text-xs text-gray-600">å¯¼å‡º/å¯¼å…¥æ¸¸æˆæ•°æ®</p>
              </div>
            </div>
            <div class="flex space-x-2 mb-2">
              <button id="export-data-btn" class="flex-1 bg-primary hover:bg-opacity-90 text-white px-3 py-2 rounded-lg font-medium text-sm btn-shadow transition-all">
                å¯¼å‡ºæ•°æ®
              </button>
              <button id="import-data-btn" class="flex-1 bg-secondary hover:bg-opacity-90 text-white px-3 py-2 rounded-lg font-medium text-sm btn-shadow transition-all">
                å¯¼å…¥æ•°æ®
              </button>
            </div>
            <input type="file" id="import-data-file" accept=".json" class="hidden">
            <p class="text-xs text-gray-400 mt-2">å¯¼å‡ºæ•°æ®å¯å¤‡ä»½æ¸¸æˆè¿›åº¦ï¼Œå¯¼å…¥æ•°æ®å¯æ¢å¤æ¸¸æˆè¿›åº¦</p>
          </div>
          
          <!-- å¿«æ·æ“ä½œ -->
          <div class="bg-gray-50 rounded-lg p-4 mt-4 border border-gray-200">
            <h3 class="font-medium text-gray-700 mb-3">å¿«æ·æ“ä½œ</h3>
            <button onclick="game.nextMonth()" class="w-full bg-gradient-primary hover:bg-opacity-90 text-white px-4 py-2 rounded-lg font-medium text-sm btn-shadow transition-all mb-2">
              â­ï¸ ä¸‹ä¸€æœˆ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- å­å—£è¯¦æƒ…é¡µé¢ -->
    <div id="child-page" class="page-content p-4 pb-24 relative z-10">
      <div class="bg-white rounded-xl p-4 card-shadow mb-4 overflow-hidden relative">
        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-accent rounded-full filter blur-3xl opacity-10 -translate-y-1/2 translate-x-1/2"></div>
        <div class="relative z-10">
          <div class="flex items-center mb-4">
            <button onclick="showPage('main', null)" class="mr-3 text-gray-500 hover:text-primary transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            <h2 class="text-lg font-bold text-primary">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å­å—£è¯¦æƒ…</h2>
          </div>
          <div id="child-detail-content">
            <!-- å­å—£è¯¦æƒ…å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-md bg-white border-t border-gray-200 shadow-lg z-20">
      <div class="flex justify-around items-center h-16">
        <button class="nav-btn active flex flex-col items-center justify-center px-4 py-2 text-primary" onclick="showPage('main', event)">
          <span class="text-xl mb-1">ğŸ </span>
          <span class="text-xs">ä¸»é¡µ</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center px-4 py-2 text-gray-500" onclick="showPage('npc', event)">
          <span class="text-xl mb-1">ğŸ’–</span>
          <span class="text-xs">å› ç¼˜å½•</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center px-4 py-2 text-gray-500" onclick="showPage('skill', event)">
          <span class="text-xl mb-1">ğŸ§¾</span>
          <span class="text-xs">åŠŸæ³•</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center px-4 py-2 text-gray-500" onclick="showPage('item', event)">
          <span class="text-xl mb-1">ğŸ§°</span>
          <span class="text-xs">ç‰©å“</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center px-4 py-2 text-gray-500" onclick="showPage('settings', event)">
          <span class="text-xl mb-1">âš™ï¸</span>
          <span class="text-xs">è®¾ç½®</span>
        </button>
      </div>
    </nav>

    <!-- é€šçŸ¥åŒºåŸŸ -->
    <div id="notification-area" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 w-11/12 max-w-md"></div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
      <div class="bg-white rounded-xl p-6 max-w-md w-11/12 max-h-85vh overflow-y-auto">
        <div id="modal-content" class="modal-content"></div>
        <div class="modal-footer-area mt-4 flex justify-end">
          <button onclick="closeModal()" class="btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- é‡æ–°å¼€å§‹æ¸¸æˆç¡®è®¤å¼¹æ¡† -->
    <div id="restart-game-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
      <div class="bg-white rounded-xl p-6 max-w-md w-11/12">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ç¡®è®¤é‡æ–°å¼€å§‹æ¸¸æˆ</h3>
        <p class="text-gray-600 mb-6">æ‚¨ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ¸¸æˆæ•°æ®ï¼ŒåŒ…æ‹¬è§’è‰²å±æ€§ã€NPCã€åŠŸæ³•ã€ç‰©å“å’Œè¿›åº¦ï¼Œä¸”ä¸å¯æ¢å¤ï¼</p>
        <div class="flex justify-end space-x-3">
          <button id="cancel-restart" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">å–æ¶ˆ</button>
          <button id="confirm-restart" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ç¡®è®¤é‡æ–°å¼€å§‹</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // æ¸¸æˆæ ¸å¿ƒç±»
    const game = {
      // æ¸¸æˆçŠ¶æ€
      state: {
        day: 1,
        time: 'è¾°æ—¶',
        turn: 0,
        character: {
          name: 'æ¡ƒå¤­',
          gender: 'å¥³',
          lifespan: { current: 18, max: 100 },
          constitution: { type: 'å¤©ç”Ÿåªšéª¨', desc: 'ä¸å¼‚æ€§/åŒæ€§åŒä¿®æ—¶ï¼ŒåŒæ–¹æƒ…æ¬²èƒ½é‡çº¯åº¦+20%' },
          cultivation: { level: 'ç‚¼æ°”åˆæœŸ', progress: 75, max: 100 },
          charm: 70,
          talent: 15,
          wisdom: 10,
          spiritualPower: { current: 20, max: 20 },
          physique: { current: 20, max: 20 },
          karma: 0,
          reputation: { value: 5, desc: 'é»˜é»˜æ— é—»' },
          spiritStones: 500,
          status: 'å¥åº·',
          pregnancy: { isPregnant: false, month: 0, father: null, startDay: 0 },
          children: []
        },
        npcs: [],
        skills: [
          { name: 'é˜´é˜³å’Œåˆå¿ƒç»', level: 50, max: 100, desc: 'åˆæ¬¢å®—åŸºç¡€å¿ƒæ³•ï¼Œä¿®ç‚¼é€Ÿåº¦+10%' },
          { name: 'å§¹å¥³å¿ƒç»', level: 0, max: 100, desc: 'é€‚åˆå¥³æ€§ä¿®ç‚¼çš„ç§˜æ³•ï¼Œé­…åŠ›+5ï¼Œé‡‡è¡¥æ—¶æ•ˆæœæå‡15%' },
          { name: 'ç´ å¥³å¿ƒç»', level: 0, max: 100, desc: 'ä¸Šå¤ä¼ ä¸‹çš„åŒä¿®ç§˜æ³•ï¼Œå¯ä¸å¤šäººåŒä¿®ï¼Œæ•ˆæœæå‡10%' }
        ],
        items: [
          { name: 'åˆæ¬¢å®—å¼Ÿå­ä»¤ç‰Œ', type: 'ä»¤ç‰Œ', count: 1, desc: 'åˆæ¬¢å®—èº«ä»½è±¡å¾' },
          { name: 'åªšæœ¯é“ƒ', type: 'æ³•å™¨', count: 1, desc: 'ä½¿ç”¨åå¯æå‡é­…åŠ›' }
        ],
        history: []
      },

      // å¢ƒç•Œåˆ—è¡¨
      cultivationLevels: [
        { name: 'ç‚¼æ°”åˆæœŸ', max: 100, next: 'ç‚¼æ°”ä¸­æœŸ' },
        { name: 'ç‚¼æ°”ä¸­æœŸ', max: 200, next: 'ç‚¼æ°”åæœŸ' },
        { name: 'ç‚¼æ°”åæœŸ', max: 300, next: 'ç­‘åŸºåˆæœŸ' },
        { name: 'ç­‘åŸºåˆæœŸ', max: 500, next: 'ç­‘åŸºä¸­æœŸ' },
        { name: 'ç­‘åŸºä¸­æœŸ', max: 800, next: 'ç­‘åŸºåæœŸ' },
        { name: 'ç­‘åŸºåæœŸ', max: 1200, next: 'é‡‘ä¸¹åˆæœŸ' },
        { name: 'é‡‘ä¸¹åˆæœŸ', max: 2000, next: 'é‡‘ä¸¹ä¸­æœŸ' },
        { name: 'é‡‘ä¸¹ä¸­æœŸ', max: 3000, next: 'é‡‘ä¸¹åæœŸ' },
        { name: 'é‡‘ä¸¹åæœŸ', max: 5000, next: 'å…ƒå©´åˆæœŸ' },
        { name: 'å…ƒå©´åˆæœŸ', max: 8000, next: 'å…ƒå©´ä¸­æœŸ' },
        { name: 'å…ƒå©´ä¸­æœŸ', max: 12000, next: 'å…ƒå©´åæœŸ' },
        { name: 'å…ƒå©´åæœŸ', max: 20000, next: 'åŒ–ç¥åˆæœŸ' },
        { name: 'åŒ–ç¥åˆæœŸ', max: 30000, next: 'åŒ–ç¥ä¸­æœŸ' },
        { name: 'åŒ–ç¥ä¸­æœŸ', max: 50000, next: 'åŒ–ç¥åæœŸ' },
        { name: 'åŒ–ç¥åæœŸ', max: 80000, next: 'æ¸¡åŠ«æœŸ' },
        { name: 'æ¸¡åŠ«æœŸ', max: 100000, next: 'é£å‡' }
      ],

      // è¡ŒåŠ¨åˆ—è¡¨
      actions: [
        { id: 'cultivate', name: 'ğŸ“š åŠŸæ³•ä¿®ç‚¼', desc: 'æ¶ˆè€—æ—¶é—´ä¿®ç‚¼åŠŸæ³•ï¼Œæå‡ä¿®ä¸º', cost: { time: 1 } },
        { id: 'dualCultivate', name: 'ğŸ›ï¸ åŒä¿®/å¤šä¿®', desc: 'ä¸NPCè¿›è¡ŒåŒä¿®ï¼Œå¤§å¹…æå‡ä¿®ä¸º', cost: { time: 1, physique: 1 } },
        { id: 'extract', name: 'ğŸ’‹ é‡‡è¡¥', desc: 'é‡‡è¡¥NPCä¿®ä¸ºï¼Œå¯èƒ½å¢åŠ ä¸šéšœ', cost: { time: 1, physique: 2 } },
        { id: 'bath', name: 'â™¨ï¸ é†‰æ¢¦æ± æ²æµ´', desc: 'æ¢å¤çµåŠ›ï¼Œå¯èƒ½é‡åˆ°NPC', cost: { time: 1 } },
        { id: 'market', name: 'ğŸ é€›å®—é—¨å¸‚é›†', desc: 'è´­ä¹°ä¸¹è¯ã€æ³•å™¨ã€ææ–™', cost: { time: 1 } },
        { id: 'mission', name: 'ğŸ“‹ å®—é—¨ä»»åŠ¡', desc: 'æ¥å–ä»»åŠ¡è·å¾—è´¡çŒ®ç‚¹å’Œèµ„æº', cost: { time: 1 } },
        { id: 'adventure', name: 'ğŸ—ºï¸ å¤–å‡ºå†ç»ƒ', desc: 'æ¢ç´¢ç§˜å¢ƒï¼Œå¯èƒ½è·å¾—å¥‡é‡', cost: { time: 2 } },
        { id: 'rest', name: 'ğŸ’¤ ä¼‘æ¯è°ƒå…»', desc: 'æ¢å¤ä½“é­„å’ŒçµåŠ›', cost: { time: 1 } }
      ],

      // NPCå¤´åƒåˆ—è¡¨
      npcAvatars: [
        'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/cd6a1b7c81184d68afcc694951da663d~tplv-a9rns2rl98-image.image?rcl=20251107154009649CA6622D232BA389A9&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1765093254&x-signature=tOIIiUPkP4B2fm8hIEaBuYEjtj8%3D'
      ],

      // åˆå§‹åŒ–æ¸¸æˆ
      init() {
        const hasSave = this.load();
        this.updateDisplay();
        // åªæœ‰åœ¨æ²¡æœ‰å­˜æ¡£æ—¶æ‰ç”Ÿæˆåˆå§‹NPC
        if (!hasSave) {
          this.generateRandomNPCs();
          this.showNotification('æ¬¢è¿æ¥åˆ°åˆæ¬¢å®—ä¿®ç‚¼æ¨¡æ‹Ÿå™¨ï¼', 'success');
        } else {
          this.showNotification('æ¸¸æˆå·²åŠ è½½ï¼', 'success');
        }
        this.showCurrentEvent();
        this.createParticles();
      },

      // åˆ›å»ºç²’å­æ•ˆæœ
      createParticles() {
        const container = document.querySelector('.app-container');
        const colors = ['#FFB6C1', '#9ED2BE', '#9EC3FF', '#FFD591'];
        
        for (let i = 0; i < 10; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          
          // éšæœºå¤§å°
          const size = Math.random() * 10 + 5;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          
          // éšæœºä½ç½®
          particle.style.left = `${Math.random() * 100}%`;
          particle.style.top = `${Math.random() * 100}%`;
          
          // éšæœºé¢œè‰²
          particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          
          // éšæœºåŠ¨ç”»
          const duration = Math.random() * 20 + 10;
          const delay = Math.random() * 5;
          particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
          
          container.appendChild(particle);
        }
      },

      // æ›´æ–°æ˜¾ç¤º
      updateDisplay() {
        const c = this.state.character;
        
        // æ›´æ–°åŸºæœ¬ä¿¡æ¯
        document.getElementById('character-name').textContent = c.name;
        document.getElementById('character-gender').textContent = c.gender;
        document.getElementById('time-display').textContent = `ç¬¬${this.state.day}å¤©Â·${this.getTimeOfDay()}Â·${this.state.time}`;
        
        // æ›´æ–°å±æ€§æ¡
        this.updateBar('lifespan', c.lifespan.current, c.lifespan.max);
        this.updateBar('cultivation', c.cultivation.progress, c.cultivation.max);
        this.updateBar('charm', c.charm, 100);
        this.updateBar('talent', c.talent, 100);
        this.updateBar('wisdom', c.wisdom, 100);
        
        // æ›´æ–°æ•°å€¼æ˜¾ç¤º
        document.getElementById('lifespan-value').textContent = `${c.lifespan.current}/${c.lifespan.max}`;
        document.getElementById('constitution').textContent = c.constitution.type;
        document.getElementById('cultivation-level').textContent = `${c.cultivation.level} (${c.cultivation.progress}/${c.cultivation.max})`;
        document.getElementById('charm-value').textContent = `${c.charm}/100`;
        document.getElementById('talent-value').textContent = `${c.talent}/100`;
        document.getElementById('wisdom-value').textContent = `${c.wisdom}/100`;
        document.getElementById('spiritual-power').textContent = `${c.spiritualPower.current}/${c.spiritualPower.max}`;
        document.getElementById('physique').textContent = `${c.physique.current}/${c.physique.max}`;
        document.getElementById('karma').textContent = `${c.karma}/100`;
        document.getElementById('reputation').textContent = `${c.reputation.value}/100 (${c.reputation.desc})`;
        document.getElementById('spirit-stones').textContent = c.spiritStones;
        
        // æ›´æ–°æ€€å­•çŠ¶æ€
        const pregnancyStatus = document.getElementById('pregnancy-status');
        const pregnancyInfo = document.getElementById('pregnancy-info');
        if (c.pregnancy && c.pregnancy.isPregnant) {
          pregnancyStatus.style.display = 'flex';
          const fatherName = c.pregnancy.father ? c.pregnancy.father.name : 'æœªçŸ¥';
          pregnancyInfo.textContent = `å­•${c.pregnancy.month}æœˆï¼ˆçˆ¶ï¼š${fatherName}ï¼‰`;
        } else {
          pregnancyStatus.style.display = 'none';
        }
        
        // æ›´æ–°å­å—£åˆ—è¡¨
        this.updateChildrenList();
        
        // æ›´æ–°è¡ŒåŠ¨æŒ‰é’®
        this.updateActionButtons();
        
        // æ›´æ–°NPCåˆ—è¡¨
        this.updateNPCList();
        
        // æ›´æ–°åŠŸæ³•åˆ—è¡¨
        this.updateSkillList();
        
        // æ›´æ–°ç‰©å“åˆ—è¡¨
        this.updateItemList();
      },

      // æ›´æ–°è¿›åº¦æ¡
      updateBar(id, current, max) {
        const percentage = Math.min(100, (current / max) * 100);
        const bar = document.getElementById(`${id}-bar`);
        if (bar) {
          bar.style.width = `${percentage}%`;
        }
      },

      // æ›´æ–°è¡ŒåŠ¨æŒ‰é’®
      updateActionButtons() {
        const container = document.getElementById('action-buttons');
        container.innerHTML = '';
        
        this.actions.forEach(action => {
          const btn = document.createElement('button');
          
          // æ£€æŸ¥èµ„æºæ˜¯å¦è¶³å¤Ÿ
          let canAfford = true;
          if (action.cost.stones && this.state.character.spiritStones < action.cost.stones) {
            canAfford = false;
          }
          if (action.cost.physique && this.state.character.physique.current < action.cost.physique) {
            canAfford = false;
          }
          
          btn.className = `btn ${canAfford ? 'bg-gradient-primary' : 'bg-gray-300'} text-white py-3 px-4 rounded-lg font-medium btn-shadow text-sm relative overflow-hidden`;
          btn.textContent = action.name;
          
          // æ·»åŠ æŒ‰é’®æè¿°
          const tooltip = document.createElement('div');
          tooltip.className = 'absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-gray-800 text-white text-xs rounded py-1 px-2 opacity-0 transition-opacity duration-300 pointer-events-none whitespace-nowrap';
          tooltip.textContent = action.desc;
          btn.appendChild(tooltip);
          
          // æ·»åŠ æ‚¬åœæ•ˆæœ
          btn.addEventListener('mouseenter', () => {
            tooltip.style.opacity = '1';
          });
          
          btn.addEventListener('mouseleave', () => {
            tooltip.style.opacity = '0';
          });
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          if (canAfford) {
            btn.onclick = () => this.executeAction(action.id);
          } else {
            btn.onclick = () => {
              if (action.cost.stones && this.state.character.spiritStones < action.cost.stones) {
                this.showNotification('çµçŸ³ä¸è¶³ï¼', 'danger');
              } else if (action.cost.physique && this.state.character.physique.current < action.cost.physique) {
                this.showNotification('ä½“é­„ä¸è¶³ï¼Œéœ€è¦ä¼‘æ¯ï¼', 'danger');
              }
            };
          }
          
          container.appendChild(btn);
        });
      },

      // æ‰§è¡Œè¡ŒåŠ¨
      executeAction(actionId) {
        const action = this.actions.find(a => a.id === actionId);
        if (!action) return;
        
        // æ£€æŸ¥èµ„æº
        if (action.cost.stones && this.state.character.spiritStones < action.cost.stones) {
          this.showNotification('çµçŸ³ä¸è¶³ï¼', 'danger');
          return;
        }
        
        if (action.cost.physique && this.state.character.physique.current < action.cost.physique) {
          this.showNotification('ä½“é­„ä¸è¶³ï¼Œéœ€è¦ä¼‘æ¯ï¼', 'danger');
          return;
        }
        
        // æ¶ˆè€—èµ„æº
        if (action.cost.stones) this.state.character.spiritStones -= action.cost.stones;
        if (action.cost.physique) this.state.character.physique.current -= action.cost.physique;
        
        // æ‰§è¡Œè¡ŒåŠ¨æ•ˆæœ
        switch(actionId) {
          case 'cultivate':
            this.cultivate();
            break;
          case 'dualCultivate':
            this.showDualCultivateMenu();
            break;
          case 'extract':
            this.showExtractMenu();
            break;
          case 'bath':
            this.bath();
            break;
          case 'market':
            this.showMarket();
            break;
          case 'mission':
            this.showMissions();
            break;
          case 'adventure':
            this.adventure();
            break;
          case 'rest':
            this.rest();
            break;
        }
        
        this.updateDisplay();
      },

      // åŠŸæ³•ä¿®ç‚¼
      cultivate() {
        // æ˜¾ç¤ºåŠŸæ³•é€‰æ‹©ç•Œé¢
        let html = '<h3 class="text-lg font-bold mb-4 text-primary">ğŸ“š é€‰æ‹©è¦ä¿®ç‚¼çš„åŠŸæ³•</h3><div class="space-y-3">';
        this.state.skills.forEach((skill, idx) => {
          const canCultivate = skill.level < skill.max;
          html += `
            <button onclick="game.cultivateSkill(${idx}); closeModal();" 
                    class="w-full btn ${canCultivate ? 'bg-purple-100 hover:bg-purple-200' : 'bg-gray-100'} text-left p-3 rounded-lg border ${canCultivate ? 'border-purple-300' : 'border-gray-300'}"
                    ${!canCultivate ? 'disabled' : ''}>
              <div class="flex justify-between items-center">
                <div class="flex-1">
                  <div class="font-bold text-primary">${skill.name}</div>
                  <div class="text-xs text-gray-600 mt-1">${skill.desc || 'æ— æè¿°'}</div>
                  <div class="text-xs text-gray-500 mt-1">ç†Ÿç»ƒåº¦: ${skill.level}/${skill.max}</div>
                </div>
                <div class="text-right">
                  ${canCultivate ? '<span class="text-sm text-purple-600">â–¶ ä¿®ç‚¼</span>' : '<span class="text-sm text-gray-400">å·²æ»¡çº§</span>'}
                </div>
              </div>
            </button>
          `;
        });
        html += '</div>';
        
        this.showModal(html);
      },
      
      // ä¿®ç‚¼æŒ‡å®šåŠŸæ³•
      cultivateSkill(skillIndex) {
        const skill = this.state.skills[skillIndex];
        if (!skill || skill.level >= skill.max) {
          this.showNotification('è¯¥åŠŸæ³•å·²æ»¡çº§æˆ–ä¸å­˜åœ¨ï¼', 'danger');
          return;
        }
        
        const oldLevel = skill.level;
        const gain = 10 + Math.floor(Math.random() * 20) + this.state.character.talent / 10;
        
        this.state.character.cultivation.progress += gain;
        skill.level = Math.min(skill.max, skill.level + 1);
        
        // å¦‚æœä¿®ç‚¼ã€Šå§¹å¥³å¿ƒç»ã€‹ä¸”ç­‰çº§ä»0å˜ä¸º1ï¼Œå¢åŠ 5ç‚¹é­…åŠ›
        if (skill.name === 'å§¹å¥³å¿ƒç»' && oldLevel === 0 && skill.level > 0) {
          this.state.character.charm = Math.min(100, this.state.character.charm + 5);
          this.showNotification(`ä¿®ç‚¼ ${skill.name}ï¼Œè·å¾—ä¿®ä¸º +${gain}ï¼Œé­…åŠ› +5ï¼`, 'success');
        } else {
          this.showNotification(`ä¿®ç‚¼ ${skill.name}ï¼Œè·å¾—ä¿®ä¸º +${gain}ï¼Œç†Ÿç»ƒåº¦ +1`, 'success');
        }
        
        // æ£€æŸ¥çªç ´
        this.checkBreakthrough();
        
        this.addHistory(`ä¿®ç‚¼äº† ${skill.name}ï¼Œè·å¾—ä¿®ä¸º +${gain}`);
        this.save(); // ä¿®ç‚¼åç«‹å³ä¿å­˜
        this.updateDisplay();
      },

      // æ£€æŸ¥çªç ´
      checkBreakthrough() {
        const c = this.state.character;
        const currentLevel = this.cultivationLevels.find(l => l.name === c.cultivation.level);
        
        if (currentLevel && c.cultivation.progress >= currentLevel.max) {
          c.cultivation.progress = 0;
          c.cultivation.level = currentLevel.next;
          c.cultivation.max = currentLevel.next ? this.cultivationLevels.find(l => l.name === currentLevel.next).max : 100000;
          
          if (currentLevel.next === 'é£å‡') {
            this.showNotification('ğŸ‰ æ­å–œé£å‡ï¼æ¸¸æˆç»“æŸï¼', 'success');
          } else {
            this.showNotification(`âœ¨ çªç ´æˆåŠŸï¼è¾¾åˆ° ${currentLevel.next}ï¼`, 'success');
            c.lifespan.max += Math.floor(Math.random() * 50) + 50;
          }
        }
      },
      

      // æ˜¾ç¤ºåŒä¿®èœå•
      showDualCultivateMenu() {
        const availableNPCs = this.state.npcs.filter(npc => npc.favorability >= 60);
        
        if (availableNPCs.length === 0) {
          this.showNotification('æ²¡æœ‰å¯åŒä¿®çš„NPCï¼ˆéœ€è¦å¥½æ„Ÿåº¦â‰¥60ï¼‰', 'danger');
          return;
        }
        
        // æ£€æŸ¥ç´ å¥³å¿ƒç»æ˜¯å¦æ»¡çº§
        const suNvSkill = this.state.skills.find(s => s.name === 'ç´ å¥³å¿ƒç»');
        const canMultiCultivate = suNvSkill && suNvSkill.level >= 100;
        
        if (canMultiCultivate) {
          // ç´ å¥³å¿ƒç»æ»¡çº§ï¼šæ˜¾ç¤ºå¤šä¿®èœå•ï¼ˆæ”¯æŒé€‰æ‹©1-5åå¯¹è±¡ï¼‰
          // åŒä¿®éœ€è¦60åŠä»¥ä¸Šï¼Œå¤šä¿®éœ€è¦100åŠä»¥ä¸Š
          const dualCultivateNPCs = availableNPCs; // 60åŠä»¥ä¸Š
          const multiCultivateNPCs = availableNPCs.filter(npc => npc.favorability >= 100); // 100åŠä»¥ä¸Š
          this.showMultiCultivateMenu(dualCultivateNPCs, multiCultivateNPCs);
        } else {
          // å•ä¿®æ¨¡å¼ï¼šåªèƒ½é€‰æ‹©ä¸€ä¸ªå¯¹è±¡
          let html = '<h3 class="text-lg font-bold mb-4 text-primary">ğŸ›ï¸ é€‰æ‹©åŒä¿®å¯¹è±¡</h3>';
          html += '<p class="text-xs text-gray-500 mb-3">ğŸ’¡ å°†ç´ å¥³å¿ƒç»ä¿®ç‚¼è‡³100%å¯è§£é”å¤šä¿®åŠŸèƒ½ï¼ˆå¯é€‰æ‹©1-5åå¯¹è±¡ï¼‰</p>';
          html += '<div class="space-y-3">';
          availableNPCs.forEach((npc, idx) => {
            // å¥½æ„Ÿåº¦é¢œè‰²
            let favorColor = 'text-gray-600';
            if (npc.favorability >= 80) favorColor = 'text-pink-600';
            else if (npc.favorability >= 60) favorColor = 'text-purple-600';
            else if (npc.favorability >= 40) favorColor = 'text-blue-600';
            
            html += `
              <button onclick="game.dualCultivate(game.state.npcs.find(n => n.id === ${npc.id})); closeModal();" 
                      class="w-full btn bg-pink-100 hover:bg-pink-200 text-left p-3 rounded-lg border border-pink-300 transition-all duration-300 transform hover:-translate-y-1">
                <div class="flex items-center">
                  <div class="npc-avatar mr-3">
                    <img src="${npc.avatar || this.npcAvatars[0]}" alt="${npc.name}" class="w-full h-full object-cover">
                  </div>
                  <div class="flex-1">
                    <div class="font-bold text-primary">${npc.name}</div>
                    <div class="text-xs text-gray-600">${npc.title}${npc.gender ? `-${npc.gender}` : ''}${npc.age ? `-${npc.age}` : ''}-${npc.appearance}</div>
                    <div class="text-xs mt-1 ${favorColor}">å¥½æ„Ÿåº¦: ${npc.favorability} (${npc.relationship})</div>
                  </div>
                </div>
              </button>
            `;
          });
          html += '</div>';
          this.showModal(html);
        }
      },

      // æ˜¾ç¤ºå¤šä¿®èœå•
      showMultiCultivateMenu(dualCultivateNPCs, multiCultivateNPCs) {
        let html = '<h3 class="text-lg font-bold mb-4 text-primary">ğŸ›ï¸ é€‰æ‹©åŒä¿®/å¤šä¿®å¯¹è±¡</h3>';
        html += '<p class="text-xs text-gray-500 mb-3">âœ¨ ç´ å¥³å¿ƒç»å·²æ»¡çº§ï¼Œå¯é€‰æ‹©1åå¯¹è±¡è¿›è¡ŒåŒä¿®ï¼ˆå¥½æ„Ÿåº¦â‰¥60ï¼‰ï¼Œæˆ–é€‰æ‹©2-5åå¯¹è±¡è¿›è¡Œå¤šä¿®ï¼ˆå¥½æ„Ÿåº¦â‰¥100ï¼‰</p>';
        html += '<div id="multi-cultivate-selected" class="mb-3 p-2 bg-purple-50 rounded-lg border border-purple-200 hidden">';
        html += '<div class="text-xs font-bold text-purple-600 mb-1">å·²é€‰æ‹©ï¼š<span id="selected-count">0</span>å</div>';
        html += '<div id="selected-npcs-list" class="text-xs text-gray-600"></div>';
        html += '</div>';
        html += '<div class="space-y-2 max-h-96 overflow-y-auto">';
        
        dualCultivateNPCs.forEach((npc, idx) => {
          // å¥½æ„Ÿåº¦é¢œè‰²
          let favorColor = 'text-gray-600';
          if (npc.favorability >= 100) favorColor = 'text-pink-600';
          else if (npc.favorability >= 80) favorColor = 'text-pink-500';
          else if (npc.favorability >= 60) favorColor = 'text-purple-600';
          
          // åˆ¤æ–­æ˜¯å¦å¯ä»¥å¤šä¿®
          const canMulti = npc.favorability >= 100;
          const multiTag = canMulti ? '<span class="text-xs bg-pink-100 text-pink-600 px-1 py-0.5 rounded ml-1">å¯å¤šä¿®</span>' : '';
          
          html += `
            <label class="flex items-center w-full btn bg-pink-50 hover:bg-pink-100 text-left p-3 rounded-lg border border-pink-200 transition-all duration-300 cursor-pointer">
              <input type="checkbox" value="${npc.id}" class="multi-cultivate-checkbox mr-3 w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" onchange="game.updateMultiCultivateSelection()">
              <div class="flex items-center flex-1">
                <div class="npc-avatar mr-3">
                  <img src="${npc.avatar || this.npcAvatars[0]}" alt="${npc.name}" class="w-full h-full object-cover">
                </div>
                <div class="flex-1">
                  <div class="font-bold text-primary">${npc.name}${multiTag}</div>
                  <div class="text-xs text-gray-600">${npc.title}${npc.gender ? `-${npc.gender}` : ''}${npc.age ? `-${npc.age}` : ''}-${npc.appearance}</div>
                  <div class="text-xs mt-1 ${favorColor}">å¥½æ„Ÿåº¦: ${npc.favorability} (${npc.relationship})</div>
                </div>
              </div>
            </label>
          `;
        });
        html += '</div>';
        html += '<div class="mt-4 flex space-x-2">';
        html += '<button id="confirm-multi-cultivate" onclick="game.confirmMultiCultivate()" class="flex-1 bg-primary hover:bg-opacity-90 text-white px-4 py-2 rounded-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>ç¡®è®¤</button>';
        html += '<button id="cancel-multi-cultivate" onclick="closeModal()" class="btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">å–æ¶ˆ</button>';
        html += '</div>';
        
        this.showModal(html);
        // éšè—æ¨¡æ€æ¡†footeråŒºåŸŸçš„å…³é—­æŒ‰é’®
        const footerArea = document.querySelector('.modal-footer-area');
        if (footerArea) {
          footerArea.style.display = 'none';
        }
        // åˆå§‹åŒ–é€‰æ‹©çŠ¶æ€
        this.multiCultivateSelected = [];
      },

      // æ›´æ–°å¤šä¿®é€‰æ‹©çŠ¶æ€
      updateMultiCultivateSelection() {
        const checkboxes = document.querySelectorAll('.multi-cultivate-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        const selectedCount = selectedIds.length;
        
        // é™åˆ¶æœ€å¤šé€‰æ‹©5å
        if (selectedCount > 5) {
          this.showNotification('æœ€å¤šåªèƒ½é€‰æ‹©5åå¯¹è±¡ï¼', 'danger');
          // å–æ¶ˆæœ€åä¸€ä¸ªé€‰æ‹©ï¼ˆæ‰¾åˆ°ç¬¬6ä¸ªè¢«é€‰ä¸­çš„ï¼‰
          const allChecked = Array.from(document.querySelectorAll('.multi-cultivate-checkbox:checked'));
          if (allChecked.length > 5) {
            allChecked[5].checked = false;
          }
          // é‡æ–°è·å–é€‰ä¸­çš„ID
          const newCheckboxes = document.querySelectorAll('.multi-cultivate-checkbox:checked');
          this.multiCultivateSelected = Array.from(newCheckboxes).map(cb => parseInt(cb.value));
          // é‡æ–°è®¡ç®—æ•°é‡
          const finalCount = this.multiCultivateSelected.length;
          
          // æ›´æ–°æ˜¾ç¤º
          const selectedDiv = document.getElementById('multi-cultivate-selected');
          const countSpan = document.getElementById('selected-count');
          const listDiv = document.getElementById('selected-npcs-list');
          const confirmBtn = document.getElementById('confirm-multi-cultivate');
          
          if (finalCount > 0) {
            selectedDiv.classList.remove('hidden');
            countSpan.textContent = finalCount;
            
            const selectedNPCs = this.state.npcs.filter(npc => this.multiCultivateSelected.includes(npc.id));
            listDiv.innerHTML = selectedNPCs.map(npc => npc.name).join('ã€');
            
            // å…è®¸é€‰æ‹©1åæˆ–2-5å
            if (finalCount >= 1 && finalCount <= 5) {
              // æ£€æŸ¥æ¡ä»¶
              let canConfirm = true;
              let warningMsg = '';
              const selectedNPCs = this.state.npcs.filter(npc => this.multiCultivateSelected.includes(npc.id));
              
              if (finalCount === 1) {
                // å•ä¿®ï¼šéœ€è¦å¥½æ„Ÿåº¦â‰¥60
                if (selectedNPCs[0].favorability < 60) {
                  canConfirm = false;
                  warningMsg = 'ï¼ˆéœ€è¦å¥½æ„Ÿåº¦â‰¥60ï¼‰';
                }
                confirmBtn.textContent = 'ç¡®è®¤åŒä¿®' + warningMsg;
              } else {
                // å¤šä¿®ï¼šéœ€è¦æ‰€æœ‰NPCå¥½æ„Ÿåº¦â‰¥100
                const invalidNPCs = selectedNPCs.filter(npc => npc.favorability < 100);
                if (invalidNPCs.length > 0) {
                  canConfirm = false;
                  warningMsg = `ï¼ˆ${invalidNPCs.map(n => n.name).join('ã€')}å¥½æ„Ÿåº¦ä¸è¶³100ï¼‰`;
                }
                confirmBtn.textContent = 'ç¡®è®¤å¤šä¿®' + warningMsg;
              }
              
              confirmBtn.disabled = !canConfirm;
            } else {
              confirmBtn.disabled = true;
            }
          } else {
            selectedDiv.classList.add('hidden');
            confirmBtn.disabled = true;
          }
          return;
        }
        
        this.multiCultivateSelected = selectedIds;
        
        // æ›´æ–°æ˜¾ç¤º
        const selectedDiv = document.getElementById('multi-cultivate-selected');
        const countSpan = document.getElementById('selected-count');
        const listDiv = document.getElementById('selected-npcs-list');
        const confirmBtn = document.getElementById('confirm-multi-cultivate');
        
        if (selectedCount > 0) {
          selectedDiv.classList.remove('hidden');
          countSpan.textContent = selectedCount;
          
          // æ˜¾ç¤ºå·²é€‰æ‹©çš„NPCåç§°
          const selectedNPCs = this.state.npcs.filter(npc => selectedIds.includes(npc.id));
          listDiv.innerHTML = selectedNPCs.map(npc => npc.name).join('ã€');
          
          // å¯ç”¨/ç¦ç”¨ç¡®è®¤æŒ‰é’®ï¼ˆå…è®¸1åæˆ–2-5åï¼‰
          if (selectedCount >= 1 && selectedCount <= 5) {
            // æ£€æŸ¥æ¡ä»¶
            let canConfirm = true;
            let warningMsg = '';
            
            if (selectedCount === 1) {
              // å•ä¿®ï¼šéœ€è¦å¥½æ„Ÿåº¦â‰¥60
              if (selectedNPCs[0].favorability < 60) {
                canConfirm = false;
                warningMsg = 'ï¼ˆéœ€è¦å¥½æ„Ÿåº¦â‰¥60ï¼‰';
              }
              confirmBtn.textContent = 'ç¡®è®¤åŒä¿®' + warningMsg;
            } else {
              // å¤šä¿®ï¼šéœ€è¦æ‰€æœ‰NPCå¥½æ„Ÿåº¦â‰¥100
              const invalidNPCs = selectedNPCs.filter(npc => npc.favorability < 100);
              if (invalidNPCs.length > 0) {
                canConfirm = false;
                warningMsg = `ï¼ˆ${invalidNPCs.map(n => n.name).join('ã€')}å¥½æ„Ÿåº¦ä¸è¶³100ï¼‰`;
              }
              confirmBtn.textContent = 'ç¡®è®¤å¤šä¿®' + warningMsg;
            }
            
            confirmBtn.disabled = !canConfirm;
          } else {
            confirmBtn.disabled = true;
          }
        } else {
          selectedDiv.classList.add('hidden');
          confirmBtn.disabled = true;
        }
      },

      // ç¡®è®¤åŒä¿®/å¤šä¿®
      confirmMultiCultivate() {
        if (!this.multiCultivateSelected || this.multiCultivateSelected.length < 1 || this.multiCultivateSelected.length > 5) {
          this.showNotification('è¯·é€‰æ‹©1-5åå¯¹è±¡ï¼', 'danger');
          return;
        }
        
        const selectedNPCs = this.state.npcs.filter(npc => this.multiCultivateSelected.includes(npc.id));
        
        // å¦‚æœåªé€‰æ‹©äº†1åï¼Œä½¿ç”¨åŒä¿®ï¼ˆéœ€è¦å¥½æ„Ÿåº¦â‰¥60ï¼‰
        if (selectedNPCs.length === 1) {
          if (selectedNPCs[0].favorability < 60) {
            this.showNotification('åŒä¿®éœ€è¦å¥½æ„Ÿåº¦â‰¥60ï¼', 'danger');
            return;
          }
          this.dualCultivate(selectedNPCs[0]);
        } else {
          // å¦‚æœé€‰æ‹©äº†2-5åï¼Œä½¿ç”¨å¤šä¿®ï¼ˆéœ€è¦æ‰€æœ‰NPCå¥½æ„Ÿåº¦â‰¥100ï¼‰
          const invalidNPCs = selectedNPCs.filter(npc => npc.favorability < 100);
          if (invalidNPCs.length > 0) {
            this.showNotification(`å¤šä¿®éœ€è¦æ‰€æœ‰å¯¹è±¡å¥½æ„Ÿåº¦â‰¥100ï¼${invalidNPCs.map(n => n.name).join('ã€')}ä¸æ»¡è¶³æ¡ä»¶`, 'danger');
            return;
          }
          this.multiCultivate(selectedNPCs);
        }
        closeModal();
      },

      // å¤šä¿®
      multiCultivate(npcs) {
        if (!npcs || npcs.length < 2 || npcs.length > 5) {
          this.showNotification('å¤šä¿®éœ€è¦2-5åå¯¹è±¡ï¼', 'danger');
          return;
        }
        
        let totalGain = 0;
        const npcNames = [];
        
        npcs.forEach(npc => {
          const baseGain = 30 + Math.floor(Math.random() * 40);
          const favorBonus = npc.favorability / 10;
          let gain = Math.floor(baseGain * (1 + favorBonus / 10));
          
          // ç´ å¥³å¿ƒç»æ»¡çº§ï¼Œå¤šä¿®æ•ˆæœæå‡10%
          gain = Math.floor(gain * 1.1);
          
          totalGain += gain;
          npc.favorability = Math.min(100, npc.favorability + 5);
          this.updateNPCRelationship(npc);
          npcNames.push(npc.name);
        });
        
        this.state.character.cultivation.progress += totalGain;
        
        // æ¢å¤çµåŠ›ï¼ˆå¤šä¿®æ¢å¤æ›´å¤šï¼‰
        const spiritualGain = 10 + npcs.length * 5;
        this.state.character.spiritualPower.current = Math.min(
          this.state.character.spiritualPower.max,
          this.state.character.spiritualPower.current + spiritualGain
        );
        
        // æ£€æŸ¥çªç ´
        this.checkBreakthrough();
        
        // æ£€æŸ¥æ˜¯å¦æ€€å­•ï¼ˆä¸»æ§ä¸å¼‚æ€§å¤šä¿®æ—¶æ¦‚ç‡æ€€å­•ï¼‰
        if (this.state.character.pregnancy && !this.state.character.pregnancy.isPregnant) {
          // æ‰¾å‡ºå¼‚æ€§NPC
          const oppositeGenderNPCs = npcs.filter(npc => this.state.character.gender !== npc.gender);
          if (oppositeGenderNPCs.length > 0) {
            // å¤šä¿®æ—¶ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªå¼‚æ€§NPCä½œä¸ºå¯èƒ½çš„çˆ¶äº²ï¼Œæœ‰æ¦‚ç‡å¯¼è‡´æ€€å­•
            const randomNPC = oppositeGenderNPCs[Math.floor(Math.random() * oppositeGenderNPCs.length)];
            const pregnancyChance = 0.3; // 30%æ¦‚ç‡
            if (Math.random() < pregnancyChance) {
              this.state.character.pregnancy.isPregnant = true;
              this.state.character.pregnancy.month = 1;
              this.state.character.pregnancy.startDay = this.state.day;
              this.state.character.pregnancy.father = { name: randomNPC.name, id: randomNPC.id };
              this.showNotification(`ğŸ’• ä¸ ${randomNPC.name} ç­‰å¤šä¿®åï¼Œä½ å‘ç°è‡ªå·±æ€€å­•äº†ï¼`, 'success');
            }
          }
        }
        
        const notificationMsg = `ä¸ ${npcNames.join('ã€')} è¿›è¡Œå¤šä¿®ï¼Œè·å¾—ä¿®ä¸º +${totalGain}ï¼ŒçµåŠ› +${spiritualGain}ï¼ˆç´ å¥³å¿ƒç»åŠ æˆï¼‰`;
        this.showNotification(notificationMsg, 'success');
        this.addHistory(`ä¸ ${npcNames.join('ã€')}ï¼ˆå…±${npcs.length}åï¼‰è¿›è¡Œäº†å¤šä¿®`);
        this.save(); // å¤šä¿®åç«‹å³ä¿å­˜
        this.updateDisplay();
      },

      // åŒä¿®
      dualCultivate(npc) {
        if (!npc) return;
        
        const baseGain = 30 + Math.floor(Math.random() * 40);
        const favorBonus = npc.favorability / 10;
        let gain = Math.floor(baseGain * (1 + favorBonus / 10));
        
        // æ£€æŸ¥ã€Šç´ å¥³å¿ƒç»ã€‹æ•ˆæœï¼ˆåŒä¿®æ•ˆæœæå‡10%ï¼‰
        const suNvSkill = this.state.skills.find(s => s.name === 'ç´ å¥³å¿ƒç»');
        if (suNvSkill && suNvSkill.level > 0) {
          gain = Math.floor(gain * 1.1);
        }
        
        this.state.character.cultivation.progress += gain;
        npc.favorability = Math.min(100, npc.favorability + 5);
        this.updateNPCRelationship(npc);
        
        // æ¢å¤çµåŠ›
        this.state.character.spiritualPower.current = Math.min(
          this.state.character.spiritualPower.max,
          this.state.character.spiritualPower.current + 10
        );
        
        // æ£€æŸ¥çªç ´
        this.checkBreakthrough();
        
        // æ£€æŸ¥æ˜¯å¦æ€€å­•ï¼ˆä¸»æ§ä¸å¼‚æ€§åŒä¿®æ—¶æ¦‚ç‡æ€€å­•ï¼‰
        if (this.state.character.gender !== npc.gender) {
          // å¼‚æ€§åŒä¿®ï¼Œæœ‰æ¦‚ç‡æ€€å­•
          const pregnancyChance = 0.3; // 30%æ¦‚ç‡
          if (Math.random() < pregnancyChance && !this.state.character.pregnancy.isPregnant) {
            this.state.character.pregnancy.isPregnant = true;
            this.state.character.pregnancy.month = 1;
            this.state.character.pregnancy.startDay = this.state.day;
            this.state.character.pregnancy.father = { name: npc.name, id: npc.id };
            this.showNotification(`ğŸ’• ä¸ ${npc.name} åŒä¿®åï¼Œä½ å‘ç°è‡ªå·±æ€€å­•äº†ï¼`, 'success');
          }
        }
        
        let notificationMsg = `ä¸ ${npc.name} åŒä¿®ï¼Œè·å¾—ä¿®ä¸º +${gain}ï¼Œå¥½æ„Ÿåº¦ +5`;
        if (suNvSkill && suNvSkill.level > 0) {
          notificationMsg += 'ï¼ˆç´ å¥³å¿ƒç»åŠ æˆï¼‰';
        }
        this.showNotification(notificationMsg, 'success');
        this.addHistory(`ä¸ ${npc.name}ï¼ˆ${npc.title}ï¼‰è¿›è¡Œäº†åŒä¿®`);
        this.save(); // åŒä¿®åç«‹å³ä¿å­˜
        this.updateDisplay();
      },

      // æ˜¾ç¤ºé‡‡è¡¥èœå•
      showExtractMenu() {
        const availableNPCs = this.state.npcs.filter(npc => npc.favorability >= 20);
        
        if (availableNPCs.length === 0) {
          this.showNotification('æ²¡æœ‰å¯é‡‡è¡¥çš„NPC', 'danger');
          return;
        }
        
        let html = '<h3 class="text-lg font-bold mb-4 text-red-600">ğŸ’‹ é€‰æ‹©é‡‡è¡¥å¯¹è±¡</h3><div class="space-y-3">';
        availableNPCs.forEach((npc, idx) => {
          // å¥½æ„Ÿåº¦é¢œè‰²
          let favorColor = 'text-gray-600';
          if (npc.favorability >= 80) favorColor = 'text-pink-600';
          else if (npc.favorability >= 60) favorColor = 'text-purple-600';
          else if (npc.favorability >= 40) favorColor = 'text-blue-600';
          else if (npc.favorability < 0) favorColor = 'text-red-600';
          
          html += `
            <button onclick="game.extract(game.state.npcs.find(n => n.id === ${npc.id})); closeModal();" 
                    class="w-full btn bg-red-100 hover:bg-red-200 text-left p-3 rounded-lg border border-red-300 transition-all duration-300 transform hover:-translate-y-1">
              <div class="flex items-center">
                <div class="npc-avatar mr-3">
                  <img src="${npc.avatar || this.npcAvatars[0]}" alt="${npc.name}" class="w-full h-full object-cover">
                </div>
                <div class="flex-1">
                  <div class="font-bold text-red-600">${npc.name}</div>
                  <div class="text-xs text-gray-600">${npc.title}${npc.gender ? `-${npc.gender}` : ''}${npc.age ? `-${npc.age}` : ''}-${npc.appearance}</div>
                  <div class="text-xs mt-1 ${favorColor}">å¥½æ„Ÿåº¦: ${npc.favorability} (${npc.relationship})</div>
                  <div class="text-xs text-red-600 mt-1">âš ï¸ é‡‡è¡¥ä¼šé™ä½å¥½æ„Ÿåº¦å¹¶å¯èƒ½å¢åŠ ä¸šéšœ</div>
                </div>
              </div>
            </button>
          `;
        });
        html += '</div>';
        
        this.showModal(html);
      },

      // é‡‡è¡¥
      extract(npc) {
        if (!npc) return;
        
        let gain = 50 + Math.floor(Math.random() * 50);
        
        // æ£€æŸ¥ã€Šå§¹å¥³å¿ƒç»ã€‹æ•ˆæœï¼ˆé‡‡è¡¥æ—¶æ•ˆæœæå‡15%ï¼‰
        const chaNvSkill = this.state.skills.find(s => s.name === 'å§¹å¥³å¿ƒç»');
        if (chaNvSkill && chaNvSkill.level > 0) {
          gain = Math.floor(gain * 1.15);
        }
        
        this.state.character.cultivation.progress += gain;
        npc.favorability = Math.max(-100, npc.favorability - 20);
        this.updateNPCRelationship(npc);
        
        // å¢åŠ ä¸šéšœ
        if (Math.random() < 0.7) {
          this.state.character.karma += 5;
        }
        
        // æ£€æŸ¥çªç ´
        this.checkBreakthrough();
        
        let notificationMsg = `é‡‡è¡¥ ${npc.name}ï¼Œè·å¾—ä¿®ä¸º +${gain}ï¼Œå¥½æ„Ÿåº¦ -20ï¼Œä¸šéšœå¯èƒ½å¢åŠ `;
        if (chaNvSkill && chaNvSkill.level > 0) {
          notificationMsg += 'ï¼ˆå§¹å¥³å¿ƒç»åŠ æˆï¼‰';
        }
        this.showNotification(notificationMsg, 'success');
        this.addHistory(`é‡‡è¡¥äº† ${npc.name}ï¼ˆ${npc.title}ï¼‰`);
        this.save(); // é‡‡è¡¥åç«‹å³ä¿å­˜
        this.updateDisplay();
      },

      // æ²æµ´
      bath() {
        this.state.character.spiritualPower.current = this.state.character.spiritualPower.max;
        
        // å¯èƒ½é‡åˆ°NPC
        if (Math.random() < 0.3) {
          this.generateRandomNPCs(1);
          this.showNotification('åœ¨é†‰æ¢¦æ± é‡åˆ°æ–°çš„NPCï¼', 'success');
        }
        
        this.showNotification('åœ¨é†‰æ¢¦æ± æ²æµ´ï¼ŒçµåŠ›å·²æ¢å¤', 'success');
        this.save(); // æ²æµ´åç«‹å³ä¿å­˜
      },

      // æ˜¾ç¤ºåŠå¸‚
      showMarket() {
        const items = [
          { name: 'å›çµä¸¹', price: 50, effect: 'æ¢å¤çµåŠ›', icon: 'ğŸ’Š', type: 'ä¸¹è¯' },
          { name: 'å¢ä¿®ä¸¹', price: 100, effect: 'å¢åŠ ä¿®ä¸º', icon: 'ğŸ’Š', type: 'ä¸¹è¯' },
          { name: 'åªšæƒ…é¦™', price: 150, effect: 'æå‡é­…åŠ›', icon: 'ğŸŒ¸', type: 'ç‰©å“' },
          { name: 'åˆæ¬¢æ•£', price: 200, effect: 'æå‡åŒä¿®æ•ˆæœ', icon: 'ğŸ’•', type: 'ç‰©å“' },
          { name: 'èšçµé˜µ', price: 300, effect: 'ä¿®ç‚¼é€Ÿåº¦+20%', icon: 'âœ¨', type: 'æ³•å™¨' },
          { name: 'å…»é¢œä¸¹', price: 80, effect: 'æå‡é­…åŠ›', icon: 'ğŸ’Š', type: 'ä¸¹è¯' }
        ];
        
        // æ„å»ºå›ºå®šæ ‡é¢˜
        let html = '<div class="flex flex-col" style="height: 60vh; max-height: 60vh; min-height: 400px;">';
        html += '<div class="flex-shrink-0 pb-3 border-b border-gray-200 mb-3">';
        html += '<h3 class="text-lg font-bold text-primary">ğŸ å®—é—¨åŠå¸‚</h3>';
        html += '</div>';
        
        // å¯æ»šåŠ¨çš„ç‰©å“åˆ—è¡¨åŒºåŸŸ
        html += '<div class="market-scroll-area flex-1 overflow-y-auto space-y-3 pr-2" style="min-height: 0; flex: 1 1 auto;">';
        items.forEach((item, idx) => {
          const canAfford = this.state.character.spiritStones >= item.price;
          html += `
            <button onclick="game.buyItem(${JSON.stringify(item).replace(/"/g, '&quot;')});" 
                    class="w-full btn ${canAfford ? 'bg-green-100 hover:bg-green-200' : 'bg-gray-100'} text-left p-3 rounded-lg border ${canAfford ? 'border-green-300' : 'border-gray-300'} transition-all duration-300 transform hover:-translate-y-1"
                    ${!canAfford ? 'disabled' : ''}>
              <div class="flex justify-between items-center">
                <div class="flex items-center">
                  <span class="text-2xl mr-3">${item.icon}</span>
                  <div>
                    <div class="font-bold text-primary">${item.name}</div>
                    <div class="text-xs text-gray-600">${item.effect}</div>
                    <div class="text-xs text-gray-500">${item.type}</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-yellow-600">${item.price}ğŸ’°</div>
                  ${!canAfford ? '<div class="text-xs text-red-600">çµçŸ³ä¸è¶³</div>' : ''}
                </div>
              </div>
            </button>
          `;
        });
        html += '</div>';
        html += '</div>';
        
        this.showModal(html);
        
        // ç¦ç”¨ modal-content çš„æ»šåŠ¨ï¼Œè®©å†…éƒ¨åŒºåŸŸæ»šåŠ¨
        const modalContent = document.getElementById('modal-content');
        if (modalContent) {
          modalContent.style.overflow = 'hidden';
          modalContent.style.height = 'auto';
        }
        
        // æ›´æ–°å…³é—­æŒ‰é’®åŒºåŸŸï¼Œæ·»åŠ çµçŸ³æ˜¾ç¤º
        this.updateMarketFooter();
      },
      
      // æ›´æ–°åŠå¸‚åº•éƒ¨ï¼ˆçµçŸ³æ˜¾ç¤ºå’Œå…³é—­æŒ‰é’®ï¼‰
      updateMarketFooter() {
        const footerArea = document.querySelector('.modal-footer-area');
        if (footerArea) {
          footerArea.className = 'modal-footer-area mt-4 flex justify-between items-center';
          footerArea.innerHTML = `
            <div class="flex items-center text-yellow-600">
              <span class="text-xl mr-2">ğŸ’°</span>
              <span class="font-bold text-base">æ‹¥æœ‰çµçŸ³: ${this.state.character.spiritStones}</span>
            </div>
            <button onclick="closeModal()" class="btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">å…³é—­</button>
          `;
        }
      },

      // è´­ä¹°ç‰©å“
      buyItem(item) {
        if (this.state.character.spiritStones < item.price) {
          this.showNotification('çµçŸ³ä¸è¶³ï¼', 'danger');
          return;
        }
        
        this.state.character.spiritStones -= item.price;
        const existingItem = this.state.items.find(i => i.name === item.name);
        
        if (existingItem) {
          existingItem.count++;
        } else {
          // ä¿å­˜ç‰©å“ä¿¡æ¯ï¼Œä½†ä¸åŒ…å«priceå’Œeffectï¼ˆè¿™äº›æ˜¯å•†åº—ä¿¡æ¯ï¼‰
          this.state.items.push({ 
            name: item.name, 
            type: item.type || 'ç‰©å“', 
            count: 1,
            icon: item.icon || 'ğŸ',
            desc: item.effect || ''
          });
        }
        
        this.showNotification(`è´­ä¹°äº† ${item.name}`, 'success');
        this.save(); // è´­ä¹°åç«‹å³ä¿å­˜
        
        // åˆ·æ–°åŠå¸‚æ˜¾ç¤ºï¼ˆæ›´æ–°çµçŸ³æ•°é‡å’Œç‰©å“çŠ¶æ€ï¼‰
        this.showMarket();
        this.updateDisplay(); // æ›´æ–°ä¸»ç•Œé¢æ˜¾ç¤º
      },

      // æ˜¾ç¤ºä»»åŠ¡
      showMissions() {
        const missions = [
          { name: 'é‡‡é›†çµè‰', reward: { stones: 100, contribution: 10 }, icon: 'ğŸŒ¿' },
          { name: 'å·¡é€»æŠ¤å±±', reward: { stones: 150, contribution: 15 }, icon: 'ğŸ—¡ï¸' },
          { name: 'æŠ¤é€ç‰©èµ„', reward: { stones: 200, contribution: 20 }, icon: 'ğŸ“¦' },
          { name: 'æ¥å¾…å®¾å®¢', reward: { stones: 120, contribution: 12 }, icon: 'ğŸ‘¥' },
          { name: 'æ•´ç†å…¸ç±', reward: { stones: 80, contribution: 8 }, icon: 'ğŸ“š' }
        ];
        
        let html = '<h3 class="text-lg font-bold mb-4 text-primary">ğŸ“‹ å®—é—¨ä»»åŠ¡</h3><div class="space-y-3">';
        missions.forEach((mission, idx) => {
          html += `
            <button onclick="game.completeMission(${JSON.stringify(mission).replace(/"/g, '&quot;')}); closeModal();" 
                    class="w-full btn bg-blue-100 hover:bg-blue-200 text-left p-3 rounded-lg border border-blue-300 transition-all duration-300 transform hover:-translate-y-1">
              <div class="flex items-center">
                <span class="text-2xl mr-3">${mission.icon}</span>
                <div class="flex-1">
                  <div class="font-bold text-primary">${mission.name}</div>
                  <div class="text-xs mt-1">å¥–åŠ±: ${mission.reward.stones}ğŸ’°çµçŸ³, ${mission.reward.contribution}è´¡çŒ®ç‚¹</div>
                </div>
                <span class="text-blue-500">â–¶</span>
              </div>
            </button>
          `;
        });
        html += '</div>';
        
        this.showModal(html);
      },

      // å®Œæˆä»»åŠ¡
      completeMission(mission) {
        this.state.character.spiritStones += mission.reward.stones;
        this.showNotification(`å®Œæˆä»»åŠ¡ ${mission.name}ï¼Œè·å¾— ${mission.reward.stones}çµçŸ³`, 'success');
        this.addHistory(`å®Œæˆäº†ä»»åŠ¡ï¼š${mission.name}`);
        this.save(); // å®Œæˆä»»åŠ¡åç«‹å³ä¿å­˜
      },

      // å†ç»ƒ
      adventure() {
        const events = [
          { type: 'å¥‡é‡', desc: 'æ¡åˆ°å¤ä¿®å£«æ®‹é­‚', effect: () => { this.state.character.wisdom += 3; return 'æ‚Ÿæ€§ +3'; } },
          { type: 'å¥‡é‡', desc: 'è¯¯å…¥çµæ°”èŠ‚ç‚¹', effect: () => { this.state.character.cultivation.progress += 50; return 'ä¿®ä¸º +50'; } },
          { type: 'å±æœº', desc: 'é­é‡å¿ƒé­”åå™¬', effect: () => { this.state.character.physique.current -= 2; return 'ä½“é­„ -2'; } },
          { type: 'å¥‡é‡', desc: 'è·å¾—çµè‰', effect: () => { this.state.character.spiritStones += 200; return 'è·å¾—200çµçŸ³'; } },
          { type: 'å±æœº', desc: 'è¢«å¦–å…½æ”»å‡»', effect: () => { this.state.character.lifespan.current -= 5; return 'å¯¿å…ƒ -5'; } }
        ];
        
        const event = events[Math.floor(Math.random() * events.length)];
        const result = event.effect();
        
        // æ£€æŸ¥çªç ´ï¼ˆå¦‚æœæ˜¯ä¿®ä¸ºå¢åŠ ï¼‰
        if (event.desc.includes('çµæ°”èŠ‚ç‚¹')) {
          this.checkBreakthrough();
        }
        
        // 30%æ¦‚ç‡é‡åˆ°é­”æ—æˆ–å¦–æ—NPC
        if (Math.random() < 0.3) {
          this.generateSpecialNPC();
        }
        
        this.showNotification(`${event.type}ï¼š${event.desc}ï¼Œ${result}`, event.type === 'å¥‡é‡' ? 'success' : 'danger');
        this.addHistory(`å¤–å‡ºå†ç»ƒï¼š${event.desc}`);
        this.save(); // å†ç»ƒåç«‹å³ä¿å­˜
      },
      
      // ç”Ÿæˆç‰¹æ®ŠNPCï¼ˆé­”æ—/å¦–æ—ï¼‰
      generateSpecialNPC() {
        const races = ['é­”æ—', 'å¦–æ—'];
        const race = races[Math.floor(Math.random() * races.length)];
        
        // é­”æ—åå­—åº“
        const demonNames = ['å¤œ', 'è¡€', 'æš—', 'é­”', 'ç…', 'å†¥', 'å¹½', 'é‚ª'];
        const demonTitles = ['é­”å°Š', 'é­”å°†', 'é­”å¥³', 'é­”å­', 'é­”å›', 'é­”ä¸»'];
        
        // å¦–æ—åå­—åº“
        const demonNames2 = ['ç‹', 'ç‹¼', 'è›‡', 'è™', 'è±¹', 'é¹°', 'å‡¤', 'é¾™'];
        const demonTitles2 = ['å¦–ç‹', 'å¦–å°†', 'å¦–å¥³', 'å¦–ä¸»', 'å¦–å›', 'å¦–å°Š'];
        
        const gender = Math.random() < 0.5 ? 'ç”·' : 'å¥³';
        const age = 18 + Math.floor(Math.random() * 182);
        
        let name, title;
        if (race === 'é­”æ—') {
          const surname = demonNames[Math.floor(Math.random() * demonNames.length)];
          const givenName = gender === 'ç”·' ? 'æ— ç—•' : 'é­…å½±';
          name = surname + givenName;
          title = demonTitles[Math.floor(Math.random() * demonTitles.length)];
        } else {
          const surname = demonNames2[Math.floor(Math.random() * demonNames2.length)];
          const givenName = gender === 'ç”·' ? 'å•¸å¤©' : 'åªšå„¿';
          name = surname + givenName;
          title = demonTitles2[Math.floor(Math.random() * demonTitles2.length)];
        }
        
        const appearances = ['ç¾å¦‚å† ç‰', 'èº«å¦‚é’ç«¹', 'çœ‰çœ¼å«æ˜¥', 'æ¸…å†·å¦‚æœˆ', 'å¦–å¨†å¦©åªš', 'è‹±å§¿é£’çˆ½', 'æ¸©æ–‡å°”é›…', 'å™¨å®‡è½©æ˜‚'];
        
        const npc = {
          id: Date.now() + Math.random(),
          name: name,
          title: title,
          gender: gender,
          age: age,
          appearance: appearances[Math.floor(Math.random() * appearances.length)],
          charm: 70 + Math.floor(Math.random() * 30), // ç‰¹æ®ŠNPCé­…åŠ›ç¨é«˜
          favorability: Math.floor(Math.random() * 30), // åˆå§‹å¥½æ„Ÿåº¦è¾ƒä½
          relationship: 'å½¢åŒè·¯äºº',
          cultivation: 'ç­‘åŸºåˆæœŸ',
          avatar: this.npcAvatars[Math.floor(Math.random() * this.npcAvatars.length)],
          race: race,
          category: 'casual' // èæ°´ç›¸é€¢
        };
        
        // æ›´æ–°å…³ç³»çŠ¶æ€
        this.updateNPCRelationship(npc);
        
        this.state.npcs.push(npc);
        this.showNotification(`åœ¨å†ç»ƒä¸­é‡åˆ°äº†${race}${name}`, 'info');
        this.updateNPCList();
      },

      // ä¼‘æ¯
      rest() {
        this.state.character.physique.current = Math.min(
          this.state.character.physique.max,
          this.state.character.physique.current + 5
        );
        this.state.character.spiritualPower.current = Math.min(
          this.state.character.spiritualPower.max,
          this.state.character.spiritualPower.current + 5
        );
        
        this.showNotification('ä¼‘æ¯è°ƒå…»ï¼Œä½“é­„å’ŒçµåŠ›æ¢å¤', 'success');
        this.save(); // ä¼‘æ¯åç«‹å³ä¿å­˜
      },

      // ç”ŸæˆéšæœºNPC
      generateRandomNPCs(count = 3) {
        const titles = ['æ­£é“ä»™å°Š', 'é­”é“åœ£å¥³', 'æ•£ä¿®', 'å‰‘å®—å¼Ÿå­', 'ä¸¹å®—é•¿è€', 'ç¬¦å®—å¼Ÿå­', 'å™¨å®—å¤§å¸ˆ', 'å¾¡å…½å®—å°‘ä¸»'];
        const appearances = ['ç¾å¦‚å† ç‰', 'èº«å¦‚é’ç«¹', 'çœ‰çœ¼å«æ˜¥', 'æ¸…å†·å¦‚æœˆ', 'å¦–å¨†å¦©åªš', 'è‹±å§¿é£’çˆ½', 'æ¸©æ–‡å°”é›…', 'å™¨å®‡è½©æ˜‚'];
        
        // å§“æ°åº“
        const surnames = ['æ', 'ç‹', 'å¼ ', 'åˆ˜', 'é™ˆ', 'æ¨', 'èµµ', 'é»„', 'å‘¨', 'å´', 'å¾', 'å­™', 'èƒ¡', 'æœ±', 'é«˜', 'æ—', 'ä½•', 'éƒ­', 'é©¬', 'ç½—'];
        
        // ç”·æ€§åå­—åº“ï¼ˆæµ‹è¯•10ä¸ªï¼‰
        const maleNames = ['ä¸´å·', 'æ¸…æ‰¬', 'æ— ç—•', 'å¢¨', 'éœ‡å¤©', 'äº‘å³°', 'å¤©è¡Œ', 'æµ©ç„¶', 'å­è½©', 'æ–‡åš'];
        
        // å¥³æ€§åå­—åº“ï¼ˆæµ‹è¯•10ä¸ªï¼‰
        const femaleNames = ['æ¸…æœˆ', 'è‹¥é›ª', 'è½»èˆ', 'æ°´ç—•', 'ç«èˆ', 'é›¨æŸ”', 'æ¢¦ç‘¶', 'è¯—æ¶µ', 'é›…é™', 'æ€é›¨'];
        
        for (let i = 0; i < count; i++) {
          if (this.state.npcs.length >= 10) break; // æœ€å¤š10ä¸ªNPC
          
          // éšæœºç”Ÿæˆæ€§åˆ«
          const gender = Math.random() < 0.5 ? 'ç”·' : 'å¥³';
          // éšæœºç”Ÿæˆå¹´é¾„ï¼ˆ18-200å²ï¼Œé€‚åˆä¿®ä»™ä¸–ç•Œï¼‰
          const age = 18 + Math.floor(Math.random() * 182);
          
          // æ ¹æ®æ€§åˆ«é€‰æ‹©å¯¹åº”çš„åå­—åº“
          const namePool = gender === 'ç”·' ? maleNames : femaleNames;
          const surname = surnames[Math.floor(Math.random() * surnames.length)];
          const givenName = namePool[Math.floor(Math.random() * namePool.length)];
          const fullName = surname + givenName;
          
          const npc = {
            id: Date.now() + i,
            name: fullName,
            title: titles[Math.floor(Math.random() * titles.length)],
            gender: gender,
            age: age,
            appearance: appearances[Math.floor(Math.random() * appearances.length)],
            charm: 60 + Math.floor(Math.random() * 40),
            favorability: Math.floor(Math.random() * 40),
            relationship: 'å½¢åŒè·¯äºº',
            cultivation: 'ç­‘åŸºåˆæœŸ',
            avatar: this.npcAvatars[Math.floor(Math.random() * this.npcAvatars.length)],
            race: 'äººæ—', // åˆå§‹NPCéƒ½ä¸ºäººæ—
            category: 'casual' // åˆå§‹éƒ½åœ¨èæ°´ç›¸é€¢
          };
          
          // æ›´æ–°å…³ç³»çŠ¶æ€
          this.updateNPCRelationship(npc);
          
          this.state.npcs.push(npc);
        }
      },

      // æ›´æ–°NPCå…³ç³»çŠ¶æ€
      updateNPCRelationship(npc) {
        if (npc.favorability <= -1) {
          npc.relationship = 'æ•Œå¯¹';
        } else if (npc.favorability <= 20) {
          npc.relationship = 'å½¢åŒè·¯äºº';
        } else if (npc.favorability <= 40) {
          npc.relationship = 'å†·æ·¡';
        } else if (npc.favorability <= 60) {
          npc.relationship = 'å‹å–„';
        } else if (npc.favorability <= 80) {
          npc.relationship = 'äº²å¯†';
        } else {
          npc.relationship = 'å€¾å¿ƒ';
        }
        
        // å¥½æ„Ÿåº¦é¦–æ¬¡è¾¾åˆ°100æ—¶ï¼Œä»èæ°´ç›¸é€¢åŠ å…¥çº¢é¸¾è°±ï¼ˆåˆ†ç±»ä¸å†æ”¹å˜ï¼‰
        if (npc.favorability >= 100 && npc.category === 'casual') {
          npc.category = 'normal';
          this.showNotification(`ğŸ’– ${npc.name} å¥½æ„Ÿåº¦è¾¾åˆ°100ï¼Œå·²åŠ å…¥çº¢é¸¾è°±ï¼`, 'success');
        }
      },

      // ç”Ÿäº§ï¼ˆè¯ä¸‹å­©å­ï¼‰
      giveBirth() {
        if (!this.state.character.pregnancy || !this.state.character.pregnancy.isPregnant) {
          return;
        }

        // éšæœºç”Ÿæˆå­©å­æ€§åˆ«
        const childGender = Math.random() < 0.5 ? 'ç”·' : 'å¥³';
        
        // è·å–ä¸»æ§å§“æ°ï¼ˆä»ä¸»æ§åå­—ä¸­æå–ç¬¬ä¸€ä¸ªå­—ä½œä¸ºå§“æ°ï¼‰
        const mainCharacterName = this.state.character.name;
        const surname = mainCharacterName.length > 0 ? mainCharacterName[0] : 'æ';
        
        // åˆ›å»ºå­©å­å¯¹è±¡
        const child = {
          id: Date.now(),
          surname: surname,
          givenName: '', // å¾…å–å
          gender: childGender,
          birthDay: this.state.day,
          father: this.state.character.pregnancy.father,
          intimacy: 50 // åˆå§‹äº²å¯†åº¦
        };

        // é‡ç½®æ€€å­•çŠ¶æ€
        this.state.character.pregnancy.isPregnant = false;
        this.state.character.pregnancy.month = 0;
        this.state.character.pregnancy.startDay = 0;
        const fatherInfo = this.state.character.pregnancy.father;
        this.state.character.pregnancy.father = null;

        // æ˜¾ç¤ºå–åå¼¹çª—
        this.showNameChildModal(child);
      },

      // æ˜¾ç¤ºç»™å­©å­å–åå¼¹çª—
      showNameChildModal(child) {
        const genderText = child.gender === 'ç”·' ? 'ç”·å­©' : 'å¥³å­©';
        const genderEmoji = child.gender === 'ç”·' ? 'ğŸ‘¶' : 'ğŸ‘§';
        
        let html = `
          <div class="text-center">
            <div class="text-4xl mb-4">${genderEmoji}</div>
            <h2 class="text-2xl font-bold text-primary mb-2">æ­å–œï¼è¯ä¸‹${genderText}</h2>
            <p class="text-gray-600 mb-6">è¯·ä¸ºæ‚¨çš„å­©å­å–å</p>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">å§“æ°ï¼š${child.surname}</label>
              <label class="block text-sm font-medium text-gray-700 mb-2">åå­—ï¼š</label>
              <input type="text" id="child-name-input" placeholder="è¯·è¾“å…¥åå­—æˆ–ç‚¹å‡»éšæœºé€‰æ‹©" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent mb-3">
              <button onclick="game.randomChildName('${child.gender}')" 
                      class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium text-sm transition-colors mb-4">
                ğŸ² éšæœºé€‰æ‹©åå­—
              </button>
            </div>
          </div>
        `;

        // å…ˆè°ƒç”¨showModalè®¾ç½®å†…å®¹
        this.showModal(html);
        
        // ç„¶åè‡ªå®šä¹‰footerï¼ˆå¿…é¡»åœ¨showModalä¹‹åè®¾ç½®ï¼Œå¦åˆ™ä¼šè¢«è¦†ç›–ï¼‰
        const footerArea = document.querySelector('.modal-footer-area');
        if (footerArea) {
          footerArea.className = 'modal-footer-area mt-4 flex justify-end space-x-2';
          footerArea.innerHTML = `
            <button onclick="game.confirmChildName(${child.id})" 
                    class="bg-primary hover:bg-opacity-90 text-white px-6 py-2 rounded-lg font-medium">
              ç¡®è®¤
            </button>
            <button onclick="game.closeChildNameModal()" 
                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">
              å…³é—­
            </button>
          `;
        }
        
        // ä¿å­˜å½“å‰å­©å­åˆ°ä¸´æ—¶å˜é‡ï¼Œä»¥ä¾¿ç¡®è®¤æ—¶ä½¿ç”¨
        this.tempChild = child;
      },

      // éšæœºé€‰æ‹©å­©å­åå­—
      randomChildName(gender) {
        // ç”·æ€§åå­—åº“
        const maleNames = ['ä¸´å·', 'æ¸…æ‰¬', 'æ— ç—•', 'å¢¨', 'éœ‡å¤©', 'äº‘å³°', 'å¤©è¡Œ', 'æµ©ç„¶', 'å­è½©', 'æ–‡åš'];
        // å¥³æ€§åå­—åº“
        const femaleNames = ['æ¸…æœˆ', 'è‹¥é›ª', 'è½»èˆ', 'æ°´ç—•', 'ç«èˆ', 'é›¨æŸ”', 'æ¢¦ç‘¶', 'è¯—æ¶µ', 'é›…é™', 'æ€é›¨'];
        
        const namePool = gender === 'ç”·' ? maleNames : femaleNames;
        const randomName = namePool[Math.floor(Math.random() * namePool.length)];
        // æ”¯æŒå–åå’Œæ”¹åä¸¤ç§è¾“å…¥æ¡†
        const nameInput = document.getElementById('child-name-input') || document.getElementById('rename-child-input');
        if (nameInput) {
          nameInput.value = randomName;
        }
      },

      // ç¡®è®¤å­©å­å§“å
      confirmChildName(childId) {
        const nameInput = document.getElementById('child-name-input');
        let givenName = nameInput ? nameInput.value.trim() : '';
        
        // å¦‚æœåå­—ä¸ºç©ºï¼Œä½¿ç”¨éšæœºåå­—
        if (!givenName) {
          const gender = this.tempChild.gender;
          const maleNames = ['ä¸´å·', 'æ¸…æ‰¬', 'æ— ç—•', 'å¢¨', 'éœ‡å¤©', 'äº‘å³°', 'å¤©è¡Œ', 'æµ©ç„¶', 'å­è½©', 'æ–‡åš'];
          const femaleNames = ['æ¸…æœˆ', 'è‹¥é›ª', 'è½»èˆ', 'æ°´ç—•', 'ç«èˆ', 'é›¨æŸ”', 'æ¢¦ç‘¶', 'è¯—æ¶µ', 'é›…é™', 'æ€é›¨'];
          const namePool = gender === 'ç”·' ? maleNames : femaleNames;
          givenName = namePool[Math.floor(Math.random() * namePool.length)];
        }

        // æ›´æ–°å­©å­ä¿¡æ¯
        this.tempChild.givenName = givenName;
        this.tempChild.fullName = this.tempChild.surname + givenName;

        // æ·»åŠ åˆ°å­å—£åˆ—è¡¨
        if (!this.state.character.children) {
          this.state.character.children = [];
        }
        this.state.character.children.push(this.tempChild);

        // æ˜¾ç¤ºé€šçŸ¥
        const genderText = this.tempChild.gender === 'ç”·' ? 'ç”·å­©' : 'å¥³å­©';
        this.showNotification(`ğŸ‰ æ­å–œï¼æ‚¨çš„${genderText} ${this.tempChild.fullName} è¯ç”Ÿäº†ï¼`, 'success');
        this.addHistory(`è¯ä¸‹${genderText}ï¼š${this.tempChild.fullName}`);

        // æ¸…ç†ä¸´æ—¶å˜é‡
        this.tempChild = null;

        // å…³é—­å¼¹çª—
        closeModal();

        // æ›´æ–°æ˜¾ç¤º
        this.updateDisplay();
        this.save();
      },

      // å…³é—­å–åå¼¹çª—ï¼ˆéšæœºé€‰æ‹©åå­—å¹¶è‡ªåŠ¨ç¡®è®¤ï¼‰
      closeChildNameModal() {
        if (!this.tempChild) {
          closeModal();
          return;
        }

        // éšæœºé€‰æ‹©ç¬¦åˆå­©å­æ€§åˆ«çš„åå­—
        const gender = this.tempChild.gender;
        const maleNames = ['ä¸´å·', 'æ¸…æ‰¬', 'æ— ç—•', 'å¢¨', 'éœ‡å¤©', 'äº‘å³°', 'å¤©è¡Œ', 'æµ©ç„¶', 'å­è½©', 'æ–‡åš'];
        const femaleNames = ['æ¸…æœˆ', 'è‹¥é›ª', 'è½»èˆ', 'æ°´ç—•', 'ç«èˆ', 'é›¨æŸ”', 'æ¢¦ç‘¶', 'è¯—æ¶µ', 'é›…é™', 'æ€é›¨'];
        const namePool = gender === 'ç”·' ? maleNames : femaleNames;
        const randomName = namePool[Math.floor(Math.random() * namePool.length)];

        // æ›´æ–°å­©å­ä¿¡æ¯
        this.tempChild.givenName = randomName;
        this.tempChild.fullName = this.tempChild.surname + randomName;

        // æ·»åŠ åˆ°å­å—£åˆ—è¡¨
        if (!this.state.character.children) {
          this.state.character.children = [];
        }
        this.state.character.children.push(this.tempChild);

        // æ˜¾ç¤ºé€šçŸ¥
        const genderText = this.tempChild.gender === 'ç”·' ? 'ç”·å­©' : 'å¥³å­©';
        this.showNotification(`ğŸ‰ æ­å–œï¼æ‚¨çš„${genderText} ${this.tempChild.fullName} è¯ç”Ÿäº†ï¼`, 'success');
        this.addHistory(`è¯ä¸‹${genderText}ï¼š${this.tempChild.fullName}`);

        // æ¸…ç†ä¸´æ—¶å˜é‡
        this.tempChild = null;

        // å…³é—­å¼¹çª—
        closeModal();

        // æ›´æ–°æ˜¾ç¤º
        this.updateDisplay();
        this.save();
      },

      // æ›´æ–°å­å—£åˆ—è¡¨
      updateChildrenList() {
        const childrenSection = document.getElementById('children-section');
        const childrenList = document.getElementById('children-list');
        const children = this.state.character.children || [];
        
        if (children.length === 0) {
          childrenSection.style.display = 'none';
          return;
        }
        
        childrenSection.style.display = 'block';
        childrenList.innerHTML = '';
        
        // åˆ›å»ºç´§å‡‘çš„å†…è”æ˜¾ç¤ºï¼Œå§“åä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”
        const childNames = children.map((child, index) => {
          const fullName = child.fullName || (child.surname + (child.givenName || 'æœªå–å'));
          return `<span class="text-gray-800 cursor-pointer hover:text-primary transition-colors" onclick="game.showChildDetail(${child.id})">${fullName}</span>`;
        }).join(' ');
        
        childrenList.innerHTML = `<div class="flex flex-wrap gap-2 text-sm">${childNames}</div>`;
      },

      // è·å–å­å—£å…³ç³»ç­‰çº§
      getChildRelationship(intimacy) {
        if (intimacy < 20) {
          return 'é™Œç”Ÿ';
        } else if (intimacy < 40) {
          return 'ç†Ÿæ‚‰';
        } else if (intimacy < 60) {
          return 'äº²è¿‘';
        } else if (intimacy < 80) {
          return 'äº²å¯†';
        } else {
          return 'æ·±çˆ±';
        }
      },

      // æ˜¾ç¤ºå­å—£è¯¦æƒ…
      showChildDetail(childId) {
        const child = this.state.character.children.find(c => c.id === childId);
        if (!child) {
          this.showNotification('æœªæ‰¾åˆ°è¯¥å­å—£ä¿¡æ¯', 'error');
          return;
        }

        // ç¡®ä¿äº²å¯†åº¦å±æ€§å­˜åœ¨ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
        if (child.intimacy === undefined) {
          child.intimacy = 50;
        }

        const genderEmoji = child.gender === 'ç”·' ? 'ğŸ‘¶' : 'ğŸ‘§';
        const genderText = child.gender === 'ç”·' ? 'ç”·' : 'å¥³';
        const fullName = child.fullName || (child.surname + (child.givenName || 'æœªå–å'));
        // è®¡ç®—å¹´é¾„ï¼šæ¯365å¤©=1å²
        const daysOld = this.state.day - child.birthDay;
        const age = Math.floor(daysOld / 365);
        const fatherName = child.father ? child.father.name : 'æœªçŸ¥';
        const fatherTitle = child.father ? child.father.title : '';
        const intimacy = child.intimacy || 50;
        const relationship = this.getChildRelationship(intimacy);

        let html = `
          <div class="space-y-4">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg p-4 border border-pink-200">
              <div class="flex items-center space-x-4 mb-4">
                <div class="text-5xl">${genderEmoji}</div>
                <div class="flex-1">
                  <h3 class="text-2xl font-bold text-gray-800 mb-1">${fullName}</h3>
                  <div class="text-sm text-gray-600">${genderText}æ€§</div>
                </div>
              </div>
            </div>

            <!-- è¯¦ç»†ä¿¡æ¯ -->
            <div class="bg-white rounded-lg p-4 border border-gray-200 space-y-3">
              <h4 class="font-bold text-gray-700 mb-3">ğŸ“‹ è¯¦ç»†ä¿¡æ¯</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">å¹´é¾„ï¼š</span>
                  <span class="font-medium text-gray-800">${age}å²</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">æ€§åˆ«ï¼š</span>
                  <span class="font-medium text-gray-800">${genderText}æ€§</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">äº²å¯†åº¦ï¼š</span>
                  <span class="font-medium text-primary">${intimacy} (${relationship})</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">è¯ç”Ÿæ—¥æœŸï¼š</span>
                  <span class="font-medium text-gray-800">ç¬¬${child.birthDay}å¤©</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">ç”Ÿçˆ¶ï¼š</span>
                  <span class="font-medium text-gray-800">${fatherName}${fatherTitle ? ` (${fatherTitle})` : ''}</span>
                </div>
              </div>
            </div>

            <!-- äº¤äº’é€‰é¡¹ -->
            <div class="bg-white rounded-lg p-4 border border-gray-200">
              <h4 class="font-bold text-gray-700 mb-3">ğŸ® äº¤äº’é€‰é¡¹</h4>
              <div class="space-y-2">
                <button onclick="game.interactWithChild(${childId})" 
                        class="w-full bg-primary hover:bg-opacity-90 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                  ğŸ’¬ ä¸å­©å­äº’åŠ¨
                </button>
                <button onclick="game.renameChild(${childId})" 
                        class="w-full bg-secondary hover:bg-opacity-90 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                  âœï¸ æ”¹å
                </button>
              </div>
            </div>
          </div>
        `;

        const detailContent = document.getElementById('child-detail-content');
        if (detailContent) {
          detailContent.innerHTML = html;
        }

        // åˆ‡æ¢åˆ°å­å—£è¯¦æƒ…é¡µé¢
        showPage('child', null);
      },

      // ä¸å­å—£äº’åŠ¨
      interactWithChild(childId) {
        const child = this.state.character.children.find(c => c.id === childId);
        if (!child) {
          this.showNotification('æœªæ‰¾åˆ°è¯¥å­å—£ä¿¡æ¯', 'error');
          return;
        }

        const genderText = child.gender === 'ç”·' ? 'ç”·å­©' : 'å¥³å­©';
        const fullName = child.fullName || (child.surname + (child.givenName || 'æœªå–å'));
        
        // è®¡ç®—å¹´é¾„
        const daysOld = this.state.day - child.birthDay;
        const age = Math.floor(daysOld / 365);

        const interactions = [
          { name: 'é™ªä¼´', desc: 'é™ªä¼´å­©å­ï¼Œå¢è¿›æ„Ÿæƒ…', type: 'accompany' },
          { name: 'æ•™å¯¼', desc: 'æ•™å¯¼å­©å­ï¼Œæå‡èƒ½åŠ›', type: 'teach' },
          { name: 'ç©è€', desc: 'ä¸å­©å­ç©è€ï¼Œå¢åŠ å¿«ä¹', type: 'play' }
        ];

        let html = `<h3 class="text-lg font-bold mb-4 text-primary">ğŸ’¬ ä¸ ${fullName} äº’åŠ¨</h3>`;
        html += `<div class="mb-4 p-3 bg-gray-50 rounded-lg">`;
        html += `<div class="text-sm font-medium">${fullName} (${age}å²${genderText})</div>`;
        html += `</div><div class="space-y-2">`;
        
        interactions.forEach(interaction => {
          html += `
            <button onclick="game.doChildInteraction(${JSON.stringify(interaction).replace(/"/g, '&quot;')}, ${childId}); closeModal();" 
                    class="w-full btn bg-primary hover:bg-secondary text-white text-left p-3 rounded-lg">
              <div class="font-bold">${interaction.name}</div>
              <div class="text-xs opacity-90">${interaction.desc}</div>
            </button>
          `;
        });
        html += '</div>';
        
        this.showModal(html);
      },

      // æ‰§è¡Œå­å—£äº’åŠ¨
      doChildInteraction(interaction, childId) {
        const child = this.state.character.children.find(c => c.id === childId);
        if (!child) {
          this.showNotification('æœªæ‰¾åˆ°è¯¥å­å—£ä¿¡æ¯', 'error');
          return;
        }

        // ç¡®ä¿äº²å¯†åº¦å±æ€§å­˜åœ¨ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
        if (child.intimacy === undefined) {
          child.intimacy = 50;
        }

        const fullName = child.fullName || (child.surname + (child.givenName || 'æœªå–å'));
        let intimacyGain = 0;
        
        switch(interaction.type) {
          case 'accompany':
            intimacyGain = 2;
            child.intimacy = Math.min(100, child.intimacy + intimacyGain);
            this.showNotification(`ä½ é™ªä¼´äº†${fullName}ï¼Œæ„Ÿæƒ…æ›´åŠ æ·±åšäº†ï¼ˆäº²å¯†åº¦+${intimacyGain}ï¼‰`, 'success');
            this.addHistory(`é™ªä¼´å­å—£ï¼š${fullName}ï¼Œäº²å¯†åº¦+${intimacyGain}`);
            break;
          case 'teach':
            intimacyGain = 3;
            child.intimacy = Math.min(100, child.intimacy + intimacyGain);
            this.showNotification(`ä½ æ•™å¯¼äº†${fullName}ï¼Œå­©å­å—ç›ŠåŒªæµ…ï¼ˆäº²å¯†åº¦+${intimacyGain}ï¼‰`, 'success');
            this.addHistory(`æ•™å¯¼å­å—£ï¼š${fullName}ï¼Œäº²å¯†åº¦+${intimacyGain}`);
            break;
          case 'play':
            intimacyGain = 2;
            child.intimacy = Math.min(100, child.intimacy + intimacyGain);
            this.showNotification(`ä½ ä¸${fullName}ä¸€èµ·ç©è€ï¼Œå¤§å®¶éƒ½å¾ˆå¿«ä¹ï¼ˆäº²å¯†åº¦+${intimacyGain}ï¼‰`, 'success');
            this.addHistory(`ä¸å­å—£ç©è€ï¼š${fullName}ï¼Œäº²å¯†åº¦+${intimacyGain}`);
            break;
        }

        // æ›´æ–°è¯¦æƒ…é¡µé¢æ˜¾ç¤º
        this.showChildDetail(childId);
      },

      // å­å—£æ”¹å
      renameChild(childId) {
        const child = this.state.character.children.find(c => c.id === childId);
        if (!child) {
          this.showNotification('æœªæ‰¾åˆ°è¯¥å­å—£ä¿¡æ¯', 'error');
          return;
        }

        const fullName = child.fullName || (child.surname + (child.givenName || 'æœªå–å'));
        
        let html = `
          <div class="text-center">
            <h3 class="text-lg font-bold mb-4 text-primary">âœï¸ ä¸º ${fullName} æ”¹å</h3>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">å§“æ°ï¼š${child.surname}</label>
              <label class="block text-sm font-medium text-gray-700 mb-2">åå­—ï¼š</label>
              <input type="text" id="rename-child-input" placeholder="è¯·è¾“å…¥æ–°åå­—" 
                     value="${child.givenName || ''}"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent mb-3">
              <button onclick="game.randomChildName('${child.gender}')" 
                      class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium text-sm transition-colors mb-4">
                ğŸ² éšæœºé€‰æ‹©åå­—
              </button>
            </div>
          </div>
        `;

        // è‡ªå®šä¹‰footer
        const footerArea = document.querySelector('.modal-footer-area');
        if (footerArea) {
          footerArea.className = 'modal-footer-area mt-4 flex justify-end space-x-2';
          footerArea.innerHTML = `
            <button onclick="game.confirmRenameChild(${childId})" 
                    class="bg-primary hover:bg-opacity-90 text-white px-6 py-2 rounded-lg font-medium">
              ç¡®è®¤
            </button>
            <button onclick="closeModal()" 
                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">
              å–æ¶ˆ
            </button>
          `;
        }

        this.showModal(html);
      },

      // ç¡®è®¤æ”¹å
      confirmRenameChild(childId) {
        const child = this.state.character.children.find(c => c.id === childId);
        if (!child) {
          this.showNotification('æœªæ‰¾åˆ°è¯¥å­å—£ä¿¡æ¯', 'error');
          return;
        }

        const nameInput = document.getElementById('rename-child-input');
        if (!nameInput) {
          this.showNotification('è¾“å…¥æ¡†æœªæ‰¾åˆ°', 'error');
          return;
        }

        const newName = nameInput.value.trim();
        if (!newName) {
          this.showNotification('è¯·è¾“å…¥åå­—', 'error');
          return;
        }

        const oldFullName = child.fullName || (child.surname + (child.givenName || 'æœªå–å'));
        child.givenName = newName;
        child.fullName = child.surname + newName;

        this.showNotification(`å·²å°†${oldFullName}æ”¹åä¸º${child.fullName}`, 'success');
        this.addHistory(`ä¸ºå­å—£æ”¹åï¼š${oldFullName} â†’ ${child.fullName}`);
        
        // æ›´æ–°æ˜¾ç¤º
        this.updateChildrenList();
        this.showChildDetail(childId);
        
        closeModal();
      },

      // æ›´æ–°NPCåˆ—è¡¨æ˜¾ç¤º
      updateNPCList() {
        const container = document.getElementById('npc-list');
        container.innerHTML = '';
        
        if (this.state.npcs.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-4">æš‚æ— NPCï¼Œå¤–å‡ºå†ç»ƒæˆ–æ²æµ´å¯èƒ½é‡åˆ°</p>';
          return;
        }
        
        // åˆ†ç±»NPC
        const normalNPCs = this.state.npcs.filter(npc => !npc.category || npc.category === 'normal');
        const casualNPCs = this.state.npcs.filter(npc => npc.category === 'casual');
        
        // æ˜¾ç¤ºæ™®é€šNPC
        if (normalNPCs.length > 0) {
          const normalSection = document.createElement('div');
          normalSection.className = 'mb-4';
          normalSection.innerHTML = '<h3 class="text-md font-bold text-primary mb-3">ğŸ’– çº¢é¸¾è°±</h3>';
          container.appendChild(normalSection);
          
          normalNPCs.forEach(npc => {
            this.renderNPCCard(npc, container);
          });
        }
        
        // æ˜¾ç¤ºèæ°´ç›¸é€¢NPC
        if (casualNPCs.length > 0) {
          const casualSection = document.createElement('div');
          casualSection.className = 'mt-6 mb-4';
          casualSection.innerHTML = '<h3 class="text-md font-bold text-purple-600 mb-3">ğŸŒŠ èæ°´ç›¸é€¢</h3>';
          container.appendChild(casualSection);
          
          casualNPCs.forEach(npc => {
            this.renderNPCCard(npc, container);
          });
        }
      },
      
      // æ¸²æŸ“NPCå¡ç‰‡
      renderNPCCard(npc, container) {
        const card = document.createElement('div');
        card.className = 'bg-gray-50 rounded-lg p-3 border border-gray-200 mb-3 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-md';
        
        // å¥½æ„Ÿåº¦é¢œè‰²
        let favorColor = 'text-gray-600';
        if (npc.favorability >= 80) favorColor = 'text-pink-600';
        else if (npc.favorability >= 60) favorColor = 'text-purple-600';
        else if (npc.favorability >= 40) favorColor = 'text-blue-600';
        else if (npc.favorability < 0) favorColor = 'text-red-600';
        
        // ç§æ—æ ‡ç­¾é¢œè‰²
        let raceColor = 'bg-blue-100 text-blue-600';
        if (npc.race === 'é­”æ—') raceColor = 'bg-red-100 text-red-600';
        else if (npc.race === 'å¦–æ—') raceColor = 'bg-orange-100 text-orange-600';
        
        card.innerHTML = `
          <div class="flex items-start mb-2">
            <div class="npc-avatar mr-3">
              <img src="${npc.avatar || this.npcAvatars[0]}" alt="${npc.name}" class="w-full h-full object-cover">
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <h3 class="font-bold text-primary text-lg">${npc.name}</h3>
                ${npc.race ? `<span class="text-xs ${raceColor} px-2 py-0.5 rounded">${npc.race}</span>` : ''}
              </div>
              <p class="text-xs text-gray-600">${npc.title}${npc.gender ? `-${npc.gender}` : ''}${npc.age ? `-${npc.age}` : ''}-${npc.appearance}</p>
              <p class="text-xs text-gray-500 mt-1">ä¿®ä¸º: ${npc.cultivation}</p>
              <p class="text-sm ${favorColor} font-bold mt-1">å¥½æ„Ÿåº¦: ${npc.favorability} (${npc.relationship})</p>
            </div>
            <span class="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded">é­…åŠ› ${npc.charm}</span>
          </div>
          <div class="flex gap-2 mt-2">
            ${npc.favorability >= 60 ? `<button onclick="game.dualCultivate(game.state.npcs.find(n => n.id === ${npc.id}));" class="flex-1 btn bg-pink-500 text-white text-xs py-1 px-2 rounded hover:bg-pink-600 transition-colors">åŒä¿®</button>` : ''}
            ${npc.favorability >= 20 ? `<button onclick="game.extract(game.state.npcs.find(n => n.id === ${npc.id}));" class="flex-1 btn bg-red-500 text-white text-xs py-1 px-2 rounded hover:bg-red-600 transition-colors">é‡‡è¡¥</button>` : ''}
            <button onclick="game.interactWithNPC(game.state.npcs.find(n => n.id === ${npc.id}));" class="flex-1 btn bg-primary text-white text-xs py-1 px-2 rounded hover:bg-secondary transition-colors">äº’åŠ¨</button>
          </div>
        `;
        container.appendChild(card);
      },
      
      // ä¸NPCäº’åŠ¨
      interactWithNPC(npc) {
        const interactions = [
          { name: 'èŠå¤©', favorChange: 1, desc: 'ä¸NPCèŠå¤©ï¼Œå¢è¿›æ„Ÿæƒ…', type: 'chat' },
          { name: 'èµ é€ç¤¼ç‰©', favorChange: 5, desc: 'ä»èƒŒåŒ…é€‰æ‹©ç‰©å“èµ é€ï¼Œå¤§å¹…æå‡å¥½æ„Ÿ', type: 'gift' },
          { name: 'è°ƒæˆ', favorChange: 3, desc: 'è°ƒæˆNPCï¼Œæå‡å¥½æ„Ÿ', type: 'tease' }
        ];
        
        let html = `<h3 class="text-lg font-bold mb-4 text-primary">ğŸ’¬ ä¸ ${npc.name} äº’åŠ¨</h3>`;
        html += `<div class="mb-4 p-3 bg-gray-50 rounded-lg">`;
        html += `<div class="flex items-center">`;
        html += `<div class="npc-avatar mr-3">`;
        html += `<img src="${npc.avatar || this.npcAvatars[0]}" alt="${npc.name}" class="w-full h-full object-cover">`;
        html += `</div>`;
        html += `<div>`;
        html += `<div class="text-sm font-bold">${npc.name}</div>`;
        html += `<div class="text-xs text-gray-600 mt-1">${npc.title}${npc.gender ? `-${npc.gender}` : ''}${npc.age ? `-${npc.age}` : ''}-${npc.appearance}</div>`;
        html += `<div class="text-xs text-gray-500 mt-1">å¥½æ„Ÿåº¦: ${npc.favorability} (${npc.relationship})</div>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div><div class="space-y-2">`;
        
        interactions.forEach(interaction => {
          // è°ƒæˆéœ€è¦å¥½æ„Ÿåº¦â‰¥40
          if (interaction.type === 'tease' && npc.favorability < 40) {
            return; // è·³è¿‡è°ƒæˆé€‰é¡¹
          }
          
          if (interaction.type === 'gift') {
            // èµ é€ç¤¼ç‰©æŒ‰é’®ï¼Œç‚¹å‡»åæ˜¾ç¤ºç‰©å“é€‰æ‹©
            html += `
              <button onclick="game.showGiftSelection(game.state.npcs.find(n => n.id === ${npc.id}));" 
                      class="w-full btn bg-primary hover:bg-secondary text-white text-left p-3 rounded-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="font-bold">${interaction.name}</div>
                <div class="text-xs opacity-90">${interaction.desc}</div>
              </button>
            `;
          } else {
            // å…¶ä»–äº’åŠ¨æŒ‰é’®
            html += `
              <button onclick="game.doInteraction(${JSON.stringify(interaction).replace(/"/g, '&quot;')}, game.state.npcs.find(n => n.id === ${npc.id})); closeModal();" 
                      class="w-full btn bg-primary hover:bg-secondary text-white text-left p-3 rounded-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="font-bold">${interaction.name}</div>
                <div class="text-xs opacity-90">${interaction.desc}</div>
              </button>
            `;
          }
        });
        html += '</div>';
        
        this.showModal(html);
      },
      
      // æ˜¾ç¤ºç¤¼ç‰©é€‰æ‹©ç•Œé¢
      showGiftSelection(npc) {
        if (!npc) return;
        
        // è·å–å¯èµ é€çš„ç‰©å“ï¼ˆæ’é™¤åˆæ¬¢å®—å¼Ÿå­ä»¤ç‰Œï¼‰
        const giftableItems = this.state.items.filter(item => 
          item.name !== 'åˆæ¬¢å®—å¼Ÿå­ä»¤ç‰Œ' && item.count > 0
        );
        
        if (giftableItems.length === 0) {
          this.showNotification('èƒŒåŒ…ä¸­æ²¡æœ‰å¯èµ é€çš„ç‰©å“ï¼', 'danger');
          closeModal();
          return;
        }
        
        let html = `<h3 class="text-lg font-bold mb-4 text-primary">ğŸ é€‰æ‹©è¦èµ é€çš„ç¤¼ç‰©</h3>`;
        html += `<div class="mb-4 p-3 bg-gray-50 rounded-lg">`;
        html += `<div class="flex items-center">`;
        html += `<div class="npc-avatar mr-3">`;
        html += `<img src="${npc.avatar || this.npcAvatars[0]}" alt="${npc.name}" class="w-full h-full object-cover">`;
        html += `</div>`;
        html += `<div>`;
        html += `<div class="text-sm font-bold">${npc.name}</div>`;
        html += `<div class="text-xs text-gray-600 mt-1">${npc.title}${npc.gender ? `-${npc.gender}` : ''}${npc.age ? `-${npc.age}` : ''}-${npc.appearance}</div>`;
        html += `<div class="text-xs text-gray-500 mt-1">å¥½æ„Ÿåº¦: ${npc.favorability} (${npc.relationship})</div>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div><div class="space-y-2">`;
        
        giftableItems.forEach(item => {
          // æ ¹æ®ç‰©å“ç±»å‹å’Œåç§°è®¡ç®—å¥½æ„Ÿåº¦åŠ æˆ
          let favorGain = 5; // åŸºç¡€å¥½æ„Ÿåº¦
          let itemIcon = 'ğŸ';
          
          // æ ¹æ®ç‰©å“ç±»å‹è°ƒæ•´å¥½æ„Ÿåº¦åŠ æˆ
          if (item.type === 'æ³•å™¨') {
            favorGain = 8;
            itemIcon = 'âœ¨';
          } else if (item.type === 'ä¸¹è¯') {
            favorGain = 6;
            itemIcon = 'ğŸ’Š';
          } else if (item.name.includes('é¦™') || item.name.includes('æ•£')) {
            favorGain = 10;
            itemIcon = 'ğŸŒ¸';
          }
          
          html += `
            <button onclick="game.giveGift(${JSON.stringify(item).replace(/"/g, '&quot;')}, game.state.npcs.find(n => n.id === ${npc.id})); closeModal();" 
                    class="w-full btn bg-pink-100 hover:bg-pink-200 text-left p-3 rounded-lg border border-pink-300 transition-all duration-300 transform hover:-translate-y-1">
              <div class="flex justify-between items-center">
                <div class="flex items-center">
                  <span class="text-2xl mr-3">${item.icon || itemIcon}</span>
                  <div class="flex-1">
                    <div class="font-bold text-primary">${item.name}</div>
                    <div class="text-xs text-gray-600">${item.type || 'ç‰©å“'}</div>
                    <div class="text-xs text-gray-500">${item.desc || ''}</div>
                    <div class="text-xs text-pink-600 mt-1">é¢„è®¡å¥½æ„Ÿåº¦ +${favorGain}</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-bold text-gray-700">x${item.count}</div>
                </div>
              </div>
            </button>
          `;
        });
        html += '</div>';
        
        this.showModal(html);
      },
      
      // èµ é€ç¤¼ç‰©
      giveGift(item, npc) {
        if (!npc || !item) return;
        
        // æ£€æŸ¥ç‰©å“æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•°é‡
        const inventoryItem = this.state.items.find(i => i.name === item.name);
        if (!inventoryItem || inventoryItem.count <= 0) {
          this.showNotification('ç‰©å“ä¸å­˜åœ¨æˆ–æ•°é‡ä¸è¶³ï¼', 'danger');
          return;
        }
        
        // è®¡ç®—å¥½æ„Ÿåº¦åŠ æˆ
        let favorGain = 5; // åŸºç¡€å¥½æ„Ÿåº¦
        if (item.type === 'æ³•å™¨') {
          favorGain = 8;
        } else if (item.type === 'ä¸¹è¯') {
          favorGain = 6;
        } else if (item.name.includes('é¦™') || item.name.includes('æ•£')) {
          favorGain = 10;
        }
        
        // å‡å°‘ç‰©å“æ•°é‡
        inventoryItem.count--;
        if (inventoryItem.count <= 0) {
          const index = this.state.items.indexOf(inventoryItem);
          if (index > -1) {
            this.state.items.splice(index, 1);
          }
        }
        
        // å¢åŠ å¥½æ„Ÿåº¦
        npc.favorability = Math.min(100, Math.max(-100, npc.favorability + favorGain));
        this.updateNPCRelationship(npc);
        
        this.showNotification(`å‘ ${npc.name} èµ é€äº† ${item.name}ï¼Œå¥½æ„Ÿåº¦ +${favorGain}`, 'success');
        this.addHistory(`å‘ ${npc.name} èµ é€äº† ${item.name}`);
        this.save(); // èµ é€ç¤¼ç‰©åç«‹å³ä¿å­˜
        this.updateDisplay();
      },
      
      // æ‰§è¡Œäº’åŠ¨ï¼ˆèŠå¤©ã€è°ƒæˆç­‰ï¼‰
      doInteraction(interaction, npc) {
        if (!npc) return;
        
        // èµ é€ç¤¼ç‰©å·²ç»å•ç‹¬å¤„ç†ï¼Œè¿™é‡Œä¸å¤„ç†
        if (interaction.type === 'gift') {
          return;
        }
        
        npc.favorability = Math.min(100, Math.max(-100, npc.favorability + interaction.favorChange));
        this.updateNPCRelationship(npc);
        
        this.showNotification(`ä¸ ${npc.name} ${interaction.name}ï¼Œå¥½æ„Ÿåº¦ ${interaction.favorChange > 0 ? '+' : ''}${interaction.favorChange}`, 'success');
        this.addHistory(`ä¸ ${npc.name} è¿›è¡Œäº†${interaction.name}`);
        this.save(); // äº’åŠ¨åç«‹å³ä¿å­˜
        this.updateDisplay();
      },

      // æ›´æ–°åŠŸæ³•åˆ—è¡¨
      updateSkillList() {
        const container = document.getElementById('skill-list');
        container.innerHTML = '';
        
        this.state.skills.forEach(skill => {
          const card = document.createElement('div');
          card.className = 'bg-gray-50 rounded-lg p-3 border border-gray-200 skill-card transition-all duration-300 transform hover:-translate-y-1 hover:shadow-md';
          card.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-bold text-primary">${skill.name}</h3>
              <span class="text-sm text-gray-600">${skill.level}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div class="stat-bar bg-gradient-to-r from-purple-400 to-purple-600" style="width: ${skill.level}%"></div>
            </div>
            <p class="text-xs text-gray-600 mt-2">${skill.desc || 'æ— æè¿°'}</p>
          `;
          container.appendChild(card);
        });
      },

      // æ›´æ–°ç‰©å“åˆ—è¡¨
      updateItemList() {
        const container = document.getElementById('item-list');
        container.innerHTML = '';
        
        if (this.state.items.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-4">ç‰©å“æ ä¸ºç©º</p>';
          return;
        }
        
        this.state.items.forEach(item => {
          const card = document.createElement('div');
          card.className = 'bg-gray-50 rounded-lg p-3 border border-gray-200 item-card flex items-center';
          
          // æ ¹æ®ç‰©å“ç±»å‹è®¾ç½®å›¾æ ‡
          let itemIcon = 'ğŸ';
          if (item.type === 'æ³•å™¨') {
            itemIcon = 'âœ¨';
          } else if (item.type === 'ä¸¹è¯') {
            itemIcon = 'ğŸ’Š';
          } else if (item.type === 'ä»¤ç‰Œ') {
            itemIcon = 'ğŸ”–';
          } else if (item.name.includes('é¦™') || item.name.includes('æ•£')) {
            itemIcon = 'ğŸŒ¸';
          }
          
          card.innerHTML = `
            <span class="text-2xl mr-3">${item.icon || itemIcon}</span>
            <div class="flex-1">
              <h3 class="font-bold text-primary">${item.name}</h3>
              <p class="text-xs text-gray-600">${item.type || ''}</p>
              <p class="text-xs text-gray-500">${item.desc || ''}</p>
            </div>
            <span class="text-sm font-bold">x${item.count}</span>
          `;
          container.appendChild(card);
        });
      },

      // æ˜¾ç¤ºå½“å‰äº‹ä»¶
      showCurrentEvent() {
        const events = [
          'ä½ ä»é²›ç»¡çº±å¸ä¸­é†’æ¥ï¼Œæ‰«è¿‡èº«ä¾§é…£ç¡çš„å‰‘å®—é¦–å¸­å¼Ÿå­ï¼ˆæ˜¨å¤œåŒä¿®å¯¹è±¡ï¼‰ã€‚çª—å¤–é£æ¥å¸ˆå°Šä¼ è®¯ç¬¦å‘ŠçŸ¥ä½ ä¸‰æ—¥åè“¬è±ä»™å®´å°½æ˜¯ä¸Šä½³ç‚‰é¼ã€‚',
          'ä½ åœ¨æ´åºœä¸­æ‰“åï¼Œæ„Ÿå—åˆ°ä½“å†…çµåŠ›æµè½¬ï¼Œä¿®ä¸ºç•¥æœ‰ç²¾è¿›ã€‚',
          'åˆæ¬¢å®—å†…é—¨ä¼ æ¥æ¶ˆæ¯ï¼Œæœ‰æ–°çš„ä¿®ç‚¼èµ„æºå¯ä»¥å…‘æ¢ã€‚',
          'ä½ è·¯è¿‡é†‰æ¢¦æ± ï¼Œçœ‹åˆ°å‡ ä½åŒé—¨æ­£åœ¨æ²æµ´ï¼Œæ°”æ°›æ—–æ—ã€‚',
          'å¸ˆå°Šå¬è§ä½ ï¼Œè¯¢é—®è¿‘æœŸä¿®ç‚¼æƒ…å†µï¼Œå¹¶ä¼ æˆäº†ä¸€äº›å¿ƒå¾—ã€‚',
          'ä½ åœ¨è—ç»é˜ç¿»é˜…å¤ç±ï¼Œå‘ç°äº†ä¸€ç¯‡å…³äºåŒä¿®çš„ç§˜æ³•ã€‚',
          'å®—é—¨å¤§æ¯”å³å°†å¼€å§‹ï¼Œä½ éœ€è¦å‡†å¤‡å‚åŠ ã€‚',
          'ä½ æ”¶åˆ°äº†ä¸€å°æ¥è‡ªå…¶ä»–å®—é—¨çš„é‚€è¯·å‡½ï¼Œé‚€è¯·ä½ å‚åŠ ä»–ä»¬çš„åº†å…¸ã€‚'
        ];
        
        const eventText = events[Math.floor(Math.random() * events.length)];
        document.getElementById('event-content').innerHTML = `<p>${eventText}</p>`;
      },

      // ä¸‹ä¸€å›åˆ
      nextTurn() {
        this.state.turn++;
        
        // æ›´æ–°æ—¶é—´
        const times = ['è¾°æ—¶', 'å·³æ—¶', 'åˆæ—¶', 'æœªæ—¶', 'ç”³æ—¶', 'é…‰æ—¶', 'æˆŒæ—¶', 'äº¥æ—¶', 'å­æ—¶', 'ä¸‘æ—¶', 'å¯…æ—¶', 'å¯æ—¶'];
        const timeIndex = this.state.turn % 12;
        this.state.time = times[timeIndex];
        
        // æ¯12å›åˆä¸ºä¸€å¤©
        if (this.state.turn % 12 === 0) {
          this.state.day++;
          
          // æ€€å­•æœˆä»½å¢é•¿ï¼ˆæ¯30å¤©å¢åŠ 1ä¸ªæœˆï¼‰
          if (this.state.character.pregnancy && this.state.character.pregnancy.isPregnant) {
            // å¦‚æœstartDayæœªåˆå§‹åŒ–ï¼Œè®¾ç½®ä¸ºå½“å‰å¤©æ•°ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
            if (!this.state.character.pregnancy.startDay || this.state.character.pregnancy.startDay === 0) {
              this.state.character.pregnancy.startDay = this.state.day;
            }
            
            const daysPregnant = this.state.day - this.state.character.pregnancy.startDay;
            const newMonth = Math.min(10, Math.max(1, Math.floor(daysPregnant / 30) + 1));
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ»¡10ä¸ªæœˆï¼ˆ300å¤©ï¼‰ï¼Œå¦‚æœæ»¡åˆ™ç«‹å³ç”Ÿäº§
            if (daysPregnant >= 300) {
              this.giveBirth();
            } else if (newMonth > this.state.character.pregnancy.month) {
              // å¦‚æœæœˆä»½å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°å¹¶æ˜¾ç¤ºé€šçŸ¥
              this.state.character.pregnancy.month = newMonth;
              if (this.state.character.pregnancy.month >= 10) {
                // åæœˆæ€€èƒ
                this.state.character.pregnancy.month = 10;
                this.showNotification('ğŸ¤° ä½ å·²æ€€å­•10ä¸ªæœˆï¼Œå³å°†ç”Ÿäº§ï¼', 'info');
              } else {
                this.showNotification(`ğŸ¤° æ€€å­•è¿›åº¦ï¼š${this.state.character.pregnancy.month}æœˆ`, 'info');
              }
            }
          }
        }
        
        // è‡ªåŠ¨æ¢å¤
        if (this.state.turn % 3 === 0) {
          this.state.character.spiritualPower.current = Math.min(
            this.state.character.spiritualPower.max,
            this.state.character.spiritualPower.current + this.state.character.talent * 2
          );
        }
        
        // éšæœºäº‹ä»¶
        if (Math.random() < 0.3) {
          this.triggerRandomEvent();
        }
        
        // åˆ·æ–°åœºæ™¯
        this.showCurrentEvent();
        
        this.updateDisplay();
        this.save();
        this.showNotification('æ—¶é—´æ¨è¿›', 'info');
      },

      // ä¸‹ä¸€æœˆï¼ˆå¿«é€Ÿæµé€ä¸€ä¸ªæœˆæ—¶é—´ï¼‰
      nextMonth() {
        const daysInMonth = 30; // ä¸€ä¸ªæœˆ30å¤©
        const turnsInMonth = daysInMonth * 12; // ä¸€ä¸ªæœˆ360å›åˆ
        const startDay = this.state.day;
        const startTurn = this.state.turn;
        
        // è®°å½•åˆå§‹æ€€å­•çŠ¶æ€
        const wasPregnant = this.state.character.pregnancy && this.state.character.pregnancy.isPregnant;
        const initialPregnancyMonth = wasPregnant ? this.state.character.pregnancy.month : 0;
        
        // å¿«é€Ÿæ¨è¿›æ—¶é—´
        for (let i = 0; i < turnsInMonth; i++) {
          this.state.turn++;
          
          // æ›´æ–°æ—¶é—´
          const times = ['è¾°æ—¶', 'å·³æ—¶', 'åˆæ—¶', 'æœªæ—¶', 'ç”³æ—¶', 'é…‰æ—¶', 'æˆŒæ—¶', 'äº¥æ—¶', 'å­æ—¶', 'ä¸‘æ—¶', 'å¯…æ—¶', 'å¯æ—¶'];
          const timeIndex = this.state.turn % 12;
          this.state.time = times[timeIndex];
          
          // æ¯12å›åˆä¸ºä¸€å¤©
          if (this.state.turn % 12 === 0) {
            this.state.day++;
            
            // æ€€å­•æœˆä»½å¢é•¿ï¼ˆæ¯30å¤©å¢åŠ 1ä¸ªæœˆï¼‰
            if (this.state.character.pregnancy && this.state.character.pregnancy.isPregnant) {
              // å¦‚æœstartDayæœªåˆå§‹åŒ–ï¼Œè®¾ç½®ä¸ºå¼€å§‹æµé€å‰çš„å¤©æ•°ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
              if (!this.state.character.pregnancy.startDay || this.state.character.pregnancy.startDay === 0) {
                this.state.character.pregnancy.startDay = startDay;
              }
              
              const daysPregnant = this.state.day - this.state.character.pregnancy.startDay;
              const newMonth = Math.min(10, Math.max(1, Math.floor(daysPregnant / 30) + 1));
              
              // æ£€æŸ¥æ˜¯å¦æ»¡10ä¸ªæœˆï¼ˆ300å¤©ï¼‰ï¼Œå¦‚æœæ»¡åˆ™è§¦å‘ç”Ÿäº§
              if (daysPregnant >= 300 && this.state.character.pregnancy.month >= 10) {
                this.giveBirth();
                break; // ç”Ÿäº§åè·³å‡ºå¾ªç¯
              } else if (newMonth > this.state.character.pregnancy.month) {
                // æ›´æ–°æ€€å­•æœˆä»½
                this.state.character.pregnancy.month = newMonth;
              }
            }
          }
          
          // è‡ªåŠ¨æ¢å¤ï¼ˆæ¯3å›åˆï¼‰
          if (this.state.turn % 3 === 0) {
            this.state.character.spiritualPower.current = Math.min(
              this.state.character.spiritualPower.max,
              this.state.character.spiritualPower.current + this.state.character.talent * 2
            );
          }
        }
        
        // éšæœºäº‹ä»¶ï¼ˆä¸€ä¸ªæœˆ30å¤©å†…ï¼Œæ¯å¤©æœ‰30%æ¦‚ç‡è§¦å‘éšæœºäº‹ä»¶ï¼‰
        // æ¨¡æ‹Ÿ30å¤©å†…çš„éšæœºäº‹ä»¶ï¼Œä½†é™åˆ¶ä¸ºæœ€å¤š10æ¬¡ï¼Œé¿å…é€šçŸ¥è¿‡å¤š
        const daysPassed = daysInMonth;
        let eventCount = 0;
        const maxEvents = 10;
        const eventMessages = [];
        for (let day = 0; day < daysPassed && eventCount < maxEvents; day++) {
          if (Math.random() < 0.3) {
            // è§¦å‘éšæœºäº‹ä»¶ä½†ä¸æ˜¾ç¤ºé€šçŸ¥ï¼Œæ”¶é›†äº‹ä»¶ä¿¡æ¯
            const event = this.triggerRandomEventSilent();
            if (event) {
              eventMessages.push(event);
              eventCount++;
            }
          }
        }
        
        // åˆ·æ–°åœºæ™¯
        this.showCurrentEvent();
        
        // æ›´æ–°æ˜¾ç¤º
        this.updateDisplay();
        this.save();
        
        // ç»Ÿä¸€æ˜¾ç¤ºé€šçŸ¥
        this.showNotification(`â­ï¸ æ—¶é—´å¿«é€Ÿæµé€ï¼Œå·²è¿‡å»ä¸€ä¸ªæœˆï¼ˆ${daysInMonth}å¤©ï¼‰`, 'success');
        
        // æ£€æŸ¥æ€€å­•çŠ¶æ€å˜åŒ–å’Œç”Ÿäº§
        if (this.state.character.pregnancy && this.state.character.pregnancy.isPregnant) {
          // æ£€æŸ¥æ˜¯å¦å·²ç»æ»¡10ä¸ªæœˆï¼ˆ300å¤©ï¼‰ï¼Œå¦‚æœæ»¡åˆ™è§¦å‘ç”Ÿäº§
          const daysPregnant = this.state.day - this.state.character.pregnancy.startDay;
          if (daysPregnant >= 300) {
            this.giveBirth();
          } else {
            const currentMonth = this.state.character.pregnancy.month;
            if (currentMonth > initialPregnancyMonth) {
              if (currentMonth >= 10) {
                this.showNotification('ğŸ¤° ä½ å·²æ€€å­•10ä¸ªæœˆï¼Œå³å°†ç”Ÿäº§ï¼', 'info');
              } else {
                this.showNotification(`ğŸ¤° æ€€å­•è¿›åº¦ï¼š${currentMonth}æœˆ`, 'info');
              }
            }
          }
        }
        
        // æ˜¾ç¤ºéšæœºäº‹ä»¶æ‘˜è¦ï¼ˆå¦‚æœæœ‰ï¼‰
        if (eventMessages.length > 0) {
          this.showNotification(`ğŸ“‹ æœŸé—´å‘ç”Ÿäº†${eventMessages.length}ä¸ªéšæœºäº‹ä»¶`, 'info');
        }
      },

      // è§¦å‘éšæœºäº‹ä»¶
      triggerRandomEvent() {
        const events = [
          { type: 'å¥‡é‡', desc: 'åœ¨æ´åºœä¸­å‘ç°å¤ä¿®å£«é—ç•™çš„ä¸¹è¯', effect: () => { this.state.character.spiritStones += 100; return 'è·å¾—100çµçŸ³'; } },
          { type: 'å¥‡é‡', desc: 'æ„Ÿæ‚Ÿå¤©åœ°ï¼Œæ‚Ÿæ€§æå‡', effect: () => { this.state.character.wisdom += 2; return 'æ‚Ÿæ€§ +2'; } },
          { type: 'å±æœº', desc: 'ä¿®ç‚¼æ—¶å¿ƒé­”ä½œç¥Ÿ', effect: () => { this.state.character.physique.current -= 1; return 'ä½“é­„ -1'; } },
          { type: 'å¥‡é‡', desc: 'è·å¾—çµè‰', effect: () => { this.state.character.charm += 3; return 'é­…åŠ› +3'; } },
          { type: 'å±æœº', desc: 'è¢«ä»‡å®¶å¯»ä»‡', effect: () => { this.state.character.lifespan.current -= 3; return 'å¯¿å…ƒ -3'; } }
        ];
        
        const event = events[Math.floor(Math.random() * events.length)];
        const result = event.effect();
        
        this.showNotification(`${event.type}ï¼š${event.desc}ï¼Œ${result}`, event.type === 'å¥‡é‡' ? 'success' : 'danger');
        this.addHistory(`éšæœºäº‹ä»¶ï¼š${event.desc}`);
      },

      // è§¦å‘éšæœºäº‹ä»¶ï¼ˆé™é»˜ç‰ˆæœ¬ï¼Œä¸æ˜¾ç¤ºé€šçŸ¥ï¼Œè¿”å›äº‹ä»¶ä¿¡æ¯ï¼‰
      triggerRandomEventSilent() {
        const events = [
          { type: 'å¥‡é‡', desc: 'åœ¨æ´åºœä¸­å‘ç°å¤ä¿®å£«é—ç•™çš„ä¸¹è¯', effect: () => { this.state.character.spiritStones += 100; return 'è·å¾—100çµçŸ³'; } },
          { type: 'å¥‡é‡', desc: 'æ„Ÿæ‚Ÿå¤©åœ°ï¼Œæ‚Ÿæ€§æå‡', effect: () => { this.state.character.wisdom += 2; return 'æ‚Ÿæ€§ +2'; } },
          { type: 'å±æœº', desc: 'ä¿®ç‚¼æ—¶å¿ƒé­”ä½œç¥Ÿ', effect: () => { this.state.character.physique.current -= 1; return 'ä½“é­„ -1'; } },
          { type: 'å¥‡é‡', desc: 'è·å¾—çµè‰', effect: () => { this.state.character.charm += 3; return 'é­…åŠ› +3'; } },
          { type: 'å±æœº', desc: 'è¢«ä»‡å®¶å¯»ä»‡', effect: () => { this.state.character.lifespan.current -= 3; return 'å¯¿å…ƒ -3'; } }
        ];
        
        const event = events[Math.floor(Math.random() * events.length)];
        const result = event.effect();
        
        // åªæ·»åŠ åˆ°å†å²è®°å½•ï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
        this.addHistory(`éšæœºäº‹ä»¶ï¼š${event.desc}`);
        
        // è¿”å›äº‹ä»¶ä¿¡æ¯
        return { type: event.type, desc: event.desc, result: result };
      },

      // è·å–æ—¶é—´æ®µ
      getTimeOfDay() {
        const hour = Math.floor(this.state.turn / 12) % 4;
        const times = ['æ¸…æ™¨', 'æ­£åˆ', 'å‚æ™š', 'æ·±å¤œ'];
        return times[hour] || 'æ¸…æ™¨';
      },

      // æ·»åŠ å†å²è®°å½•
      addHistory(text) {
        this.state.history.unshift(`[ç¬¬${this.state.day}å¤©Â·${this.state.time}] ${text}`);
        if (this.state.history.length > 50) {
          this.state.history.pop();
        }
      },

      // æ˜¾ç¤ºé€šçŸ¥
      showNotification(message, type = 'info') {
        const notificationArea = document.getElementById('notification-area');
        const notification = document.createElement('div');
        notification.className = `notification bg-white rounded-lg p-3 mb-2 card-shadow border-l-4 ${
          type === 'success' ? 'border-green-500' : 
          type === 'danger' ? 'border-red-500' : 
          'border-blue-500'
        } transform transition-all duration-300`;
        notification.textContent = message;
        notificationArea.appendChild(notification);

        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 300);
        }, 2000);
      },

      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      showModal(html) {
        const modal = document.getElementById('modal');
        const content = document.getElementById('modal-content');
        const footerArea = document.querySelector('.modal-footer-area');
        
        // é‡ç½®æ ·å¼ï¼Œç¡®ä¿å…¶ä»–æ¨¡æ€æ¡†æ­£å¸¸æ»šåŠ¨
        content.style.overflow = '';
        content.style.height = '';
        content.innerHTML = html;
        
        // é‡ç½® footer åŒºåŸŸä¸ºé»˜è®¤çŠ¶æ€ï¼ˆåªæœ‰å…³é—­æŒ‰é’®ï¼Œå³å¯¹é½ï¼‰
        if (footerArea) {
          footerArea.className = 'modal-footer-area mt-4 flex justify-end';
          footerArea.innerHTML = '<button onclick="closeModal()" class="btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">å…³é—­</button>';
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      },
      
      // ä¿å­˜æ¸¸æˆ
      save() {
        localStorage.setItem('hehuanGame', JSON.stringify(this.state));
      },

      // åŠ è½½æ¸¸æˆ
      load() {
        const saved = localStorage.getItem('hehuanGame');
        if (saved) {
          try {
            const loadedState = JSON.parse(saved);
            // å®Œå…¨æ›¿æ¢çŠ¶æ€ï¼Œç¡®ä¿ä¿å­˜çš„æ•°æ®ä¸ä¼šè¢«é»˜è®¤å€¼è¦†ç›–
            this.state = loadedState;
            
            // ç¡®ä¿æ–°åŠŸæ³•å­˜åœ¨äºå­˜æ¡£ä¸­ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
            const requiredSkills = [
              { name: 'å§¹å¥³å¿ƒç»', level: 0, max: 100, desc: 'é€‚åˆå¥³æ€§ä¿®ç‚¼çš„ç§˜æ³•ï¼Œé­…åŠ›+5ï¼Œé‡‡è¡¥æ—¶æ•ˆæœæå‡15%' },
              { name: 'ç´ å¥³å¿ƒç»', level: 0, max: 100, desc: 'ä¸Šå¤ä¼ ä¸‹çš„åŒä¿®ç§˜æ³•ï¼Œå¯ä¸å¤šäººåŒä¿®ï¼Œæ•ˆæœæå‡10%' }
            ];
            
            requiredSkills.forEach(requiredSkill => {
              const existingSkill = this.state.skills.find(s => s.name === requiredSkill.name);
              if (!existingSkill) {
                this.state.skills.push(requiredSkill);
              }
            });
            
            // ç¡®ä¿æ€€å­•å±æ€§å­˜åœ¨ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
            if (!this.state.character.pregnancy) {
              this.state.character.pregnancy = { isPregnant: false, month: 0, father: null, startDay: 0 };
            }
            
            // ç¡®ä¿å­å—£æ•°ç»„å­˜åœ¨ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
            if (!this.state.character.children) {
              this.state.character.children = [];
            }
            
            // ç¡®ä¿æ‰€æœ‰å­å—£éƒ½æœ‰äº²å¯†åº¦å±æ€§ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
            if (this.state.character.children && this.state.character.children.length > 0) {
              this.state.character.children.forEach(child => {
                if (child.intimacy === undefined) {
                  child.intimacy = 50;
                }
              });
            }
            
            // ç¡®ä¿æ‰€æœ‰NPCéƒ½æœ‰ç§æ—å’Œåˆ†ç±»å±æ€§ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
            if (this.state.npcs && this.state.npcs.length > 0) {
              this.state.npcs.forEach(npc => {
                if (!npc.race) {
                  npc.race = 'äººæ—';
                }
                if (!npc.category) {
                  // å¦‚æœæ²¡æœ‰categoryï¼Œæ ¹æ®å½“å‰å¥½æ„Ÿåº¦åˆ¤æ–­
                  // å¦‚æœå¥½æ„Ÿåº¦>=100ï¼Œè¯´æ˜æ›¾ç»è¾¾åˆ°è¿‡ï¼Œè®¾ä¸ºnormalï¼›å¦åˆ™è®¾ä¸ºcasual
                  npc.category = npc.favorability >= 100 ? 'normal' : 'casual';
                }
                // å¦‚æœcategoryæ˜¯normalä½†å¥½æ„Ÿåº¦<100ï¼Œä¿æŒä¸å˜ï¼ˆå¯èƒ½æ›¾ç»è¾¾åˆ°è¿‡100ï¼‰
                // å¦‚æœcategoryæ˜¯casualä½†å¥½æ„Ÿåº¦>=100ï¼Œå‡çº§ä¸ºnormal
                if (npc.category === 'casual' && npc.favorability >= 100) {
                  npc.category = 'normal';
                }
              });
            }
            
            return true; // è¿”å›trueè¡¨ç¤ºæœ‰å­˜æ¡£
          } catch (e) {
            console.error('åŠ è½½å­˜æ¡£å¤±è´¥:', e);
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæ¸…é™¤æŸåçš„å­˜æ¡£
            localStorage.removeItem('hehuanGame');
            return false;
          }
        }
        return false; // è¿”å›falseè¡¨ç¤ºæ²¡æœ‰å­˜æ¡£
      }
    };
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
      const modal = document.getElementById('modal');
      const content = document.getElementById('modal-content');
      const footerArea = document.querySelector('.modal-footer-area');
      // é‡ç½®æ ·å¼
      content.style.overflow = '';
      content.style.height = '';
      // æ¢å¤footeråŒºåŸŸæ˜¾ç¤º
      if (footerArea) {
        footerArea.style.display = '';
      }
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('modal');
      if (e.target === modal) {
        closeModal();
      }
    });

    // æ˜¾ç¤ºé‡æ–°å¼€å§‹æ¸¸æˆç¡®è®¤å¼¹æ¡†
    function showRestartGameModal() {
      const modal = document.getElementById('restart-game-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // éšè—é‡æ–°å¼€å§‹æ¸¸æˆç¡®è®¤å¼¹æ¡†
    function hideRestartGameModal() {
      const modal = document.getElementById('restart-game-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // é‡æ–°å¼€å§‹æ¸¸æˆ
    function restartGame() {
      // é‡ç½®æ¸¸æˆçŠ¶æ€ä¸ºåˆå§‹å€¼
      game.state = {
        day: 1,
        time: 'è¾°æ—¶',
        turn: 0,
        character: {
          name: 'æ¡ƒå¤­',
          gender: 'å¥³',
          lifespan: { current: 18, max: 100 },
          constitution: { type: 'å¤©ç”Ÿåªšéª¨', desc: 'ä¸å¼‚æ€§/åŒæ€§åŒä¿®æ—¶ï¼ŒåŒæ–¹æƒ…æ¬²èƒ½é‡çº¯åº¦+20%' },
          cultivation: { level: 'ç‚¼æ°”åˆæœŸ', progress: 75, max: 100 },
          charm: 70,
          talent: 15,
          wisdom: 10,
          spiritualPower: { current: 20, max: 20 },
          physique: { current: 20, max: 20 },
          karma: 0,
          reputation: { value: 5, desc: 'é»˜é»˜æ— é—»' },
          spiritStones: 500,
          status: 'å¥åº·',
          pregnancy: { isPregnant: false, month: 0, father: null, startDay: 0 },
          children: []
        },
        npcs: [],
        skills: [
          { name: 'é˜´é˜³å’Œåˆå¿ƒç»', level: 50, max: 100, desc: 'åˆæ¬¢å®—åŸºç¡€å¿ƒæ³•ï¼Œä¿®ç‚¼é€Ÿåº¦+10%' },
          { name: 'å§¹å¥³å¿ƒç»', level: 0, max: 100, desc: 'é€‚åˆå¥³æ€§ä¿®ç‚¼çš„ç§˜æ³•ï¼Œé­…åŠ›+5ï¼Œé‡‡è¡¥æ—¶æ•ˆæœæå‡15%' },
          { name: 'ç´ å¥³å¿ƒç»', level: 0, max: 100, desc: 'ä¸Šå¤ä¼ ä¸‹çš„åŒä¿®ç§˜æ³•ï¼Œå¯ä¸å¤šäººåŒä¿®ï¼Œæ•ˆæœæå‡10%' }
        ],
        items: [
          { name: 'åˆæ¬¢å®—å¼Ÿå­ä»¤ç‰Œ', type: 'ä»¤ç‰Œ', count: 1, desc: 'åˆæ¬¢å®—èº«ä»½è±¡å¾' },
          { name: 'åªšæœ¯é“ƒ', type: 'æ³•å™¨', count: 1, desc: 'ä½¿ç”¨åå¯æå‡é­…åŠ›' }
        ],
        history: []
      };
      
      // æ¸…é™¤æœ¬åœ°å­˜å‚¨
      localStorage.removeItem('hehuanGame');
      
      // é‡æ–°ç”Ÿæˆåˆå§‹NPC
      game.generateRandomNPCs();
      
      // æ›´æ–°æ˜¾ç¤º
      game.updateDisplay();
      game.showCurrentEvent();
      
      // éšè—ç¡®è®¤å¼¹æ¡†
      hideRestartGameModal();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      game.showNotification('æ¸¸æˆå·²é‡æ–°å¼€å§‹ï¼', 'success');
      
      // åˆ‡æ¢åˆ°ä¸»é¡µ
      showPage('main', null);
    }

    // å¯¼å‡ºæ¸¸æˆæ•°æ®
    function exportGameData() {
      try {
        // åˆ›å»ºå¯¼å‡ºæ•°æ®å¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰æ¸¸æˆæ•°æ®
        const exportData = {
          state: game.state,
          exportDate: new Date().toISOString(),
          version: "1.0"
        };
        
        // å°†æ•°æ®è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
        const jsonString = JSON.stringify(exportData, null, 2);
        
        // åˆ›å»ºBlobå¯¹è±¡
        const blob = new Blob([jsonString], { type: 'application/json' });
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = URL.createObjectURL(blob);
        
        // åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥å¹¶è§¦å‘ç‚¹å‡»
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = `åˆæ¬¢å®—ä¿®ç‚¼æ¨¡æ‹Ÿå™¨å­˜æ¡£_ç¬¬${game.state.day}å¤©_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // é‡Šæ”¾URLå¯¹è±¡
        URL.revokeObjectURL(url);
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        game.showNotification('æ¸¸æˆæ•°æ®å·²æˆåŠŸå¯¼å‡ºï¼', 'success');
      } catch (error) {
        console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
        game.showNotification('å¯¼å‡ºæ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'danger');
      }
    }

    // å¯¼å…¥æ¸¸æˆæ•°æ®
    function importGameData(event) {
      try {
        const file = event.target.files[0];
        if (!file) return;
        
        // éªŒè¯æ–‡ä»¶ç±»å‹
        const fileName = file.name.toLowerCase();
        const isValidJsonFile = fileName.endsWith('.json') || 
                                file.type === 'application/json' || 
                                file.type === 'text/json' ||
                                file.type === '';
        
        if (!isValidJsonFile) {
          game.showNotification('è¯·é€‰æ‹©JSONæ ¼å¼çš„å­˜æ¡£æ–‡ä»¶ï¼', 'danger');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importedData = JSON.parse(e.target.result);
            
            // éªŒè¯å¯¼å…¥æ•°æ®çš„ç»“æ„
            if (!importedData.state) {
              game.showNotification('å­˜æ¡£æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–å·²æŸåï¼', 'danger');
              return;
            }
            
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            if (confirm('ç¡®å®šè¦å¯¼å…¥æ­¤å­˜æ¡£å—ï¼Ÿå½“å‰çš„æ¸¸æˆè¿›åº¦å°†è¢«è¦†ç›–ï¼')) {
              // å¯¼å…¥æ•°æ®
              game.state = importedData.state;
              
              // ç¡®ä¿æ–°åŠŸæ³•å­˜åœ¨äºå­˜æ¡£ä¸­ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
              const requiredSkills = [
                { name: 'å§¹å¥³å¿ƒç»', level: 0, max: 100, desc: 'é€‚åˆå¥³æ€§ä¿®ç‚¼çš„ç§˜æ³•ï¼Œé­…åŠ›+5ï¼Œé‡‡è¡¥æ—¶æ•ˆæœæå‡15%' },
                { name: 'ç´ å¥³å¿ƒç»', level: 0, max: 100, desc: 'ä¸Šå¤ä¼ ä¸‹çš„åŒä¿®ç§˜æ³•ï¼Œå¯ä¸å¤šäººåŒä¿®ï¼Œæ•ˆæœæå‡10%' }
              ];
              
              requiredSkills.forEach(requiredSkill => {
                const existingSkill = game.state.skills.find(s => s.name === requiredSkill.name);
                if (!existingSkill) {
                  game.state.skills.push(requiredSkill);
                }
              });
              
              // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
              game.save();
              
              // æ›´æ–°æ˜¾ç¤º
              game.updateDisplay();
              game.showCurrentEvent();
              
              // æ˜¾ç¤ºæˆåŠŸæç¤º
              game.showNotification('æ¸¸æˆæ•°æ®å·²æˆåŠŸå¯¼å…¥ï¼', 'success');
              
              // åˆ‡æ¢åˆ°ä¸»é¡µ
              showPage('main', null);
            } else {
              game.showNotification('å·²å–æ¶ˆå¯¼å…¥', 'info');
            }
          } catch (error) {
            console.error('è§£æå¯¼å…¥æ•°æ®å¤±è´¥:', error);
            game.showNotification('å­˜æ¡£æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å®Œæ•´ï¼', 'danger');
          }
        };
        
        reader.readAsText(file);
      } catch (error) {
        console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
        game.showNotification('å¯¼å…¥æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'danger');
      } finally {
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
        event.target.value = '';
      }
    }

    // é¡µé¢åˆ‡æ¢
    function showPage(pageId, event) {
      // éšè—æ‰€æœ‰é¡µé¢
      document.querySelectorAll('.page-content').forEach(page => {
        page.classList.remove('active');
      });
      
      // æ˜¾ç¤ºç›®æ ‡é¡µé¢
      document.getElementById(`${pageId}-page`).classList.add('active');
      
      // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active', 'text-primary');
        btn.classList.add('text-gray-500');
      });
      
      if (event && event.target) {
        event.target.closest('.nav-btn')?.classList.add('active', 'text-primary');
      }
      
      // æ›´æ–°æ˜¾ç¤º
      game.updateDisplay();
    }

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      game.init();
      
      // ç»‘å®šé‡æ–°å¼€å§‹æ¸¸æˆæŒ‰é’®
      const restartGameBtn = document.getElementById('restart-game-btn');
      if (restartGameBtn) {
        restartGameBtn.addEventListener('click', showRestartGameModal);
      }
      
      // ç»‘å®šç¡®è®¤é‡æ–°å¼€å§‹æŒ‰é’®
      const confirmRestartBtn = document.getElementById('confirm-restart');
      if (confirmRestartBtn) {
        confirmRestartBtn.addEventListener('click', restartGame);
      }
      
      // ç»‘å®šå–æ¶ˆé‡æ–°å¼€å§‹æŒ‰é’®
      const cancelRestartBtn = document.getElementById('cancel-restart');
      if (cancelRestartBtn) {
        cancelRestartBtn.addEventListener('click', hideRestartGameModal);
      }
      
      // ç»‘å®šå¯¼å‡ºæ•°æ®æŒ‰é’®
      const exportDataBtn = document.getElementById('export-data-btn');
      if (exportDataBtn) {
        exportDataBtn.addEventListener('click', exportGameData);
      }
      
      // ç»‘å®šå¯¼å…¥æ•°æ®æŒ‰é’®
      const importDataBtn = document.getElementById('import-data-btn');
      const importDataFile = document.getElementById('import-data-file');
      if (importDataBtn && importDataFile) {
        importDataBtn.addEventListener('click', () => {
          importDataFile.click();
        });
        importDataFile.addEventListener('change', importGameData);
      }
      
      // ç‚¹å‡»é‡æ–°å¼€å§‹æ¸¸æˆç¡®è®¤å¼¹æ¡†å¤–éƒ¨å…³é—­
      const restartModal = document.getElementById('restart-game-modal');
      if (restartModal) {
        restartModal.addEventListener('click', (e) => {
          if (e.target === restartModal) {
            hideRestartGameModal();
          }
        });
      }
    });
  </script>
</body>
</html>